/**
 * ============================================================================
 * Ù…Ù„Ù: tools_dialogue.gs â€“ AI_TOOLS_DIALOGUE (Ù†Ø³Ø®Ø© Ù…ØºÙ„ÙØ© ÙˆÙ†Ù‡Ø§Ø¦ÙŠØ©)
 * Ø§Ù„ÙˆØ¸ÙŠÙØ©: ÙˆØ­Ø¯Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ ÙˆØ§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù„Ø­Ø¸ÙŠØ© Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯ G-Assistant
 * - Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ØŒ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŒ Ø¬Ø¯Ø§ÙˆÙ„ ØªÙ„Ø®ÙŠØµÙŠØ©
 * - Ø¥Ø¯Ø§Ø±Ø© Ø³ÙŠØ§Ù‚ Ø§Ù„Ø¬Ù„Ø³Ø© (set/get) Ø¨Ù…Ø¯Ø© ØµÙ„Ø§Ø­ÙŠØ© Ø§Ø®ØªÙŠØ§Ø±ÙŠØ©
 * - ØªÙƒØ§Ù…Ù„ Ù…Ø¨Ø§Ø´Ø± Ù…Ø¹ AI_MEMORY Ùˆ AI_CORE Ùˆ ENV
 * - ÙƒÙ„ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ù…ØºÙ„Ù‘ÙØ© Ø¶Ù…Ù† ÙˆØ­Ø¯Ø© Ø¢Ù…Ù†Ø© ÙˆÙ…Ø­Ù…ÙŠØ©
 * ============================================================================
 */

var AI_TOOLS_DIALOGUE = (function(ENV, AI_MEMORY, AI_CORE) {
  'use strict';

  const SETTINGS = ENV.SETTINGS;

  // ========== 1. Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªÙØ§Ø¹Ù„ ==========

  function showMessage(level, text) {
    const emoji = {
      success: 'âœ…', warning: 'âš ï¸',
      error: 'ğŸš¨', info: 'â„¹ï¸'
    }[level] || 'ğŸ’¬';
    return { type: 'message', level, text: `${emoji} ${text}` };
  }

  function showError(message) {
    AI_MEMORY.logOperation('AI_TOOLS_DIALOGUE::showError', 'error', { message });
    return showMessage('error', message);
  }

  function askUserConfirmation(message, confirmationType = 'normal', payload = {}) {
    AI_MEMORY.logOperation('AI_TOOLS_DIALOGUE::askUserConfirmation', 'prompt', { message });
    return {
      type: 'confirmation_required',
      action: '_internal_userConfirmed',
      params: { payload, confirmationType },
      message
    };
  }

  function showSummaryTable(jsonData) {
    AI_MEMORY.logOperation('AI_TOOLS_DIALOGUE::showSummaryTable', 'visual', {});
    try {
      const data = typeof jsonData === 'string' ? JSON.parse(jsonData) : jsonData;
      if (!Array.isArray(data) || data.length === 0) {
        return showMessage("info", "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.");
      }
      const headers = Object.keys(data[0]);
      const widths = headers.map(h => h.length);

      data.forEach(row => {
        headers.forEach((h, i) => {
          const len = String(row[h] ?? '').length;
          if (len > widths[i]) widths[i] = len;
        });
      });

      const headerLine = headers.map((h, i) => h.padEnd(widths[i])).join(" â”‚ ");
      const divider    = widths.map(w => "â”€".repeat(w)).join("â”€â”¼â”€");
      const bodyRows   = data.map(row =>
        headers.map((h, i) => String(row[h] ?? '').padEnd(widths[i])).join(" â”‚ ")
      );

      return {
        type: 'summary',
        table: "```\n" + headerLine + "\n" + divider + "\n" + bodyRows.join("\n") + "\n```"
      };
    } catch (e) {
      return showError(`ÙØ´Ù„ Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„: ${e.message}`);
    }
  }

  // ========== 2. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³ÙŠØ§Ù‚ Ø§Ù„Ù„Ø­Ø¸ÙŠ ==========

  function setContext(key, value) {
    const forbidden = ["token", "sessionid", "apikey", "password"];
    if (forbidden.includes(key.toLowerCase())) {
      return showMessage("warning", `âš ï¸ Ø§Ù„Ù…ÙØªØ§Ø­ \"${key}\" Ù…Ø­Ø¬ÙˆØ² Ø£Ù…Ù†ÙŠÙ‹Ø§.`);
    }
    try {
      const ctx = AI_MEMORY.loadSessionContext();
      ctx[key] = {
        value: typeof value === 'object' ? JSON.stringify(value) : value,
        timestamp: Date.now()
      };
      AI_MEMORY.saveSessionContext(ctx);
      return showMessage("success", `âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø³ÙŠØ§Ù‚: [${key}]`);
    } catch (e) {
      return showError(`ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø³ÙŠØ§Ù‚: ${e.message}`);
    }
  }

  function getContext(key) {
    const ctx = AI_MEMORY.loadSessionContext();
    const entry = ctx[key];
    if (!entry) return showMessage("warning", `Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙŠÙ…Ø© Ù…Ø­ÙÙˆØ¸Ø© ØªØ­Øª Ø§Ù„Ù…ÙØªØ§Ø­ \"${key}\".`);

    if (entry.expiresAt && Date.now() > entry.expiresAt) {
      delete ctx[key];
      AI_MEMORY.saveSessionContext(ctx);
      return showMessage("warning", `â±ï¸ Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…ÙØªØ§Ø­ \"${key}\" ÙˆØªÙ… Ø­Ø°ÙÙ‡.`);
    }

    try {
      const parsed = JSON.parse(entry.value);
      return { type: "context_value", key, content: parsed };
    } catch {
      return { type: "context_value", key, content: entry.value };
    }
  }

  function rememberValue(key, value) { return setContext(key, value); }
  function recallValue(key) { return getContext(key); }

  function rememberFor(key, value, minutes) {
    const ctx = AI_MEMORY.loadSessionContext();
    ctx[key] = {
      value: typeof value === 'object' ? JSON.stringify(value) : value,
      timestamp: Date.now(),
      expiresAt: Date.now() + minutes * 60 * 1000
    };
    AI_MEMORY.saveSessionContext(ctx);
    return showMessage("success", `â³ ØªÙ… Ø­ÙØ¸ [${key}] Ù„Ù…Ø¯Ø© ${minutes} Ø¯Ù‚ÙŠÙ‚Ø©.`);
  }

  function clearSessionContext() {
    AI_MEMORY.saveSessionContext({});
    return showMessage("success", "ğŸ§  ØªÙ… Ù…Ø³Ø­ Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ø¬Ù„Ø³Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„.");
  }

  function summarizeSession() {
    const ctx = AI_MEMORY.loadSessionContext();
    const keys = Object.keys(ctx);
    if (keys.length === 0) return showMessage("info", "ğŸ§  Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ø¬Ù„Ø³Ø©.");

    const lines = keys.map(k => {
      const entry = ctx[k];
      const expiry = entry.expiresAt ? ` (ØªÙ†ØªÙ‡ÙŠ ÙÙŠ: ${new Date(entry.expiresAt).toLocaleTimeString()})` : '';
      return `- **${k}**${expiry}: \`${(entry.value + '').substring(0, 100)}\``;
    });

    return { type: "session_summary", content: `**Ù…Ù„Ø®Øµ Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ø¬Ù„Ø³Ø©:**\n${lines.join("\n")}` };
  }

  // ========== 3. Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª ÙˆØ§Ø³ØªØ±Ø¬Ø§Ø¹ ==========

  function suggestNextActions(jsonSuggestions) {
    try {
      const arr = JSON.parse(jsonSuggestions);
      if (!Array.isArray(arr)) throw new Error("Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù…ØµÙÙˆÙØ©.");
      return {
        type: 'suggestions',
        content: "ğŸ§­ Ù…Ø§ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØªØ§Ù„ÙŠØ©ØŸ",
        suggestions: arr
      };
    } catch (e) {
      return showError(`ÙØ´Ù„ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª: ${e.message}`);
    }
  }

  function repeatLastPrompt() {
    const ctx = AI_MEMORY.loadSessionContext();
    const prompt = ctx.lastPrompt;
    const model  = ctx.lastModel || SETTINGS.DEFAULT_MODEL;
    if (!prompt) return showMessage("warning", "âª Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ù…Ø± Ø³Ø§Ø¨Ù‚ Ù…Ø­ÙÙˆØ¸.");
    return AI_CORE.ask(prompt, model);
  }

  // ========== ğŸ“¦ Ø§Ù„ØªØµØ¯ÙŠØ± ==========
  return {
    showMessage,
    showError,
    askUserConfirmation,
    showSummaryTable,
    setContext,
    getContext,
    clearSessionContext,
    rememberValue,
    recallValue,
    rememberFor,
    summarizeSession,
    suggestNextActions,
    repeatLastPrompt
  };

})(ENV, AI_MEMORY, AI_CORE);
