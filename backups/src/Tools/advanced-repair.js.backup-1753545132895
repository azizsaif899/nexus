/// *************************************************************************************************
// --- START OF FILE: src/dev_tools/advanced_repair.js ---
// *************************************************************************************************

/**
 * @file advanced_repair.js
 * @module System.Dev.AdvancedRepair
 * @version 1.0.0
 * @author Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ²
 * @description
 * Ø£Ø¯Ø§Ø© ØªØ­Ù„ÙŠÙ„ ÙˆØªÙ‚Ø±ÙŠØ± Ù…ØªÙƒØ§Ù…Ù„Ø© Ù„Ù„Ù…Ø´Ø±ÙˆØ¹ (Ù„Ø¨ÙŠØ¦Ø© Node.js):
 * - ğŸ”§ ÙØ­Øµ Ø¨Ù†ÙŠÙˆÙŠ Ù…Ø¹Ø²Ø² Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… AST.
 * - ğŸ§  ØªØ­Ù„ÙŠÙ„ Ø³ÙŠØ§Ù‚ÙŠ Ù„Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØ§Ù„Ù…Ø¬Ø§Ù„ (Simulated for this context).
 * - ğŸ§ª ØªØµÙ†ÙŠÙ Ø°ÙƒÙŠ Ù„Ù„Ù…Ø´Ø§ÙƒÙ„ Ø­Ø³Ø¨ Ø§Ù„Ø®Ø·ÙˆØ±Ø©.
 * - ğŸ¤– Ø§Ù‚ØªØ±Ø§Ø­ Ø¥ØµÙ„Ø§Ø­Ø§Øª Ø°ÙƒÙŠØ© (Ù…Ø­Ø§ÙƒØ§Ø©).
 * - ğŸ›¡ï¸ ØªØ·Ø¨ÙŠÙ‚ Ø¢Ù…Ù† Ù„Ù„Ø¥ØµÙ„Ø§Ø­Ø§Øª Ù…Ø¹ Ù†Ù‚Ø§Ø· Ø§Ø³ØªØ¹Ø§Ø¯Ø©.
 * - ğŸ”„ ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¹Ø·ÙˆØ¨Ø© ÙˆÙŠØ³ØªÙ…Ø± ÙÙŠ Ø§Ù„ØªÙ‚Ø±ÙŠØ±.
 */

import { promises as fs } from 'fs';
import path from 'path';
import { parse } from '@babel/parser';
import traverse from '@babel/traverse';
import generate from '@babel/generator'; // Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† AST Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª

// Directories (assuming this script runs from project root)
const SRC_DIR = path.join(process.cwd(), 'src'); // Ø£Ùˆ Ø­Ø³Ø¨ Ù…Ø³Ø§Ø± Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…ØµØ¯Ø±ÙŠ Ø§Ù„ÙØ¹Ù„ÙŠ
const REPORT_DIR = path.join(process.cwd(), 'docs', 'repair_reports'); // Ù…Ø¬Ù„Ø¯ Ø®Ø§Øµ Ø¨Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±

// Default file extensions to scan
const DEFAULT_FILE_EXTENSIONS = ['.js', '.jsx', '.ts', '.tsx', '.gs']; // Ø£Ø¶Ù .gs Ù„Ù…Ù„ÙØ§Øª Apps Script

// Severity Levels as per your charter
const SEVERITY_LEVELS = {
  CRITICAL: 50, // Ø£Ø®Ø·Ø§Ø¡ ØªØ±ÙƒÙŠØ¨ÙŠØ©ØŒ Ø£Ù…Ù†ÙŠØ© Ø®Ø·ÙŠØ±Ø©
  HIGH: 40,     // Ø§Ø³ØªØ®Ø¯Ø§Ù… evalØŒ ÙˆØµÙˆÙ„ Ù…Ø¨Ø§Ø´Ø± Ù„Ù€ DOM ÙÙŠ GAS
  MEDIUM: 15,   // Ø¯ÙˆØ§Ù„ Ø·ÙˆÙŠÙ„Ø©ØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… APIs Ù…Ù‡Ù…Ù„Ø©
  LOW: 1,       // Ø£Ù‚ÙˆØ§Ø³ ÙØ§Ø±ØºØ©ØŒ Ù…Ø³Ø§ÙØ§Øª Ø¨ÙŠØ¶Ø§Ø¡ ØºÙŠØ± Ø¶Ø±ÙˆØ±ÙŠØ©
};

// --- Custom Error Classes for clarity ---
class AnalysisError extends Error {
  constructor(message, filePath, line = 0) {
    super(message);
    this.filePath = filePath;
    this.line = line;
    this.name = 'AnalysisError';
  }
}

class FixApplicationError extends Error {
  constructor(message, originalError) {
    super(message);
    this.originalError = originalError;
    this.name = 'FixApplicationError';
  }
}

// --- Core Repair Agent Logic ---
class AdvancedRepairAgent {
  constructor() {
    this.allIssues = [];
    this.skippedFiles = [];
    this.appliedFixes = [];
    this.dryRun = true; // ÙˆØ¶Ø¹ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
  }

  /**
   * ÙŠÙ†Ù‚Ø·Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù„ØªØ­Ù„ÙŠÙ„ ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±.
   * @param {object} options
   * @param {string} [options.srcDir=SRC_DIR] - Ø§Ù„Ù…Ø³Ø§Ø± Ù„Ø¬Ø°Ø± Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…ØµØ¯Ø±ÙŠ.
   * @param {string} [options.reportDir=REPORT_DIR] - Ø§Ù„Ù…Ø³Ø§Ø± Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±.
   * @param {boolean} [options.applyFixes=false] - Ù‡Ù„ ÙŠØ¬Ø¨ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥ØµÙ„Ø§Ø­Ø§Øª Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©ØŸ
   * @returns {Promise<void>}
   */
  async scanAndReport({ srcDir = SRC_DIR, reportDir = REPORT_DIR, applyFixes = false } = {}) {
    this.allIssues = [];
    this.skippedFiles = [];
    this.appliedFixes = [];
    this.dryRun = !applyFixes; // Ø¥Ø°Ø§ applyFixes=trueØŒ ÙÙ€ dryRun=false

    console.log(`\n--- ğŸš€ Ø¨Ø¯Ø¡ ØªØ­Ù„ÙŠÙ„ ÙˆØ¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ (${this.dryRun ? 'ÙˆØ¶Ø¹ Ø§Ù„ØªØ¬Ø±ÙŠØ¨' : 'ÙˆØ¶Ø¹ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ'}) ---`);
    const startTime = process.hrtime.bigint(); // ÙˆÙ‚Øª Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©

    try {
      const files = await this._collectFiles(srcDir);
      console.log(`ğŸ” ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${files.length} Ù…Ù„Ù ÙƒÙˆØ¯ Ù„ØªØ­Ù„ÙŠÙ„Ù‡.`);

      for (const filePath of files) {
        await this._tryAnalyze(filePath);
      }

      // ØªØµÙ†ÙŠÙ Ø­Ø³Ø¨ Ø§Ù„Ø®Ø·ÙˆØ±Ø©
      const sortedIssues = this.allIssues
        .map((issue, index) => ({
          ...issue,
          priority: issue.severity,
          index, // Ù„Ø¥Ø¹Ø·Ø§Ø¡ ØªØ±ØªÙŠØ¨ ÙØ±ÙŠØ¯
        }))
        .sort((a, b) => b.priority - a.priority); // Ø§Ù„Ø£Ø¹Ù†Ù Ø£ÙˆÙ„Ø§Ù‹

      console.log(`\nâœ… Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ØªØ­Ù„ÙŠÙ„. ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${this.allIssues.length} Ù…Ø´ÙƒÙ„Ø©.`);
      if (this.skippedFiles.length > 0) {
        console.warn(`âš ï¸ ØªÙ… ØªØ®Ø·Ù‘ÙŠ ${this.skippedFiles.length} Ù…Ù„ÙÙ‹Ø§ Ø¨Ø³Ø¨Ø¨ Ø£Ø®Ø·Ø§Ø¡.`);
      }

      // Ø¥Ø°Ø§ ÙƒØ§Ù† ÙˆØ¶Ø¹ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØŒ Ù‚Ù… Ø¨ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥ØµÙ„Ø§Ø­Ø§Øª
      if (!this.dryRun) {
        console.log('\nğŸ”§ Ø¬Ø§Ø±ÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥ØµÙ„Ø§Ø­Ø§Øª Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©...');
        for (const issue of sortedIssues) {
          if (issue.fixable && issue.suggestedFix) {
            try {
              await this._applyFix(issue);
            } catch (error) {
              console.error(`âŒ ÙØ´Ù„ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ù„Ù„Ù…Ø´ÙƒÙ„Ø© ${issue.type} ÙÙŠ ${issue.file}: ${error.message}`);
            }
          }
        }
        console.log(`âœ… ØªÙ… ØªØ·Ø¨ÙŠÙ‚ ${this.appliedFixes.length} Ø¥ØµÙ„Ø§Ø­Ù‹Ø§.`);
      }

      // ØªÙˆÙ„ÙŠØ¯ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
      const mdReportContent = this._generateMarkdownReport(sortedIssues);

      // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§
      await fs.mkdir(reportDir, { recursive: true });

      const reportPath = path.join(reportDir, `repair_summary_${new Date().toISOString().replace(/[:.]/g, '-')}.md`);
      await fs.writeFile(reportPath, mdReportContent, 'utf8');

      const endTime = process.hrtime.bigint(); // ÙˆÙ‚Øª Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
      const durationMs = Number(endTime - startTime) / 1_000_000;

      console.log(`\nğŸ“„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ØªÙ… Ø­ÙØ¸Ù‡ Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ: ${reportPath}`);
      const stats = await fs.stat(reportPath);
      console.log(`ğŸ“ Ø­Ø¬Ù… Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ${stats.size} Ø¨Ø§ÙŠØª`);
      console.log(`â±ï¸ ÙˆÙ‚Øª Ø§Ù„ØªÙ†ÙÙŠØ° Ø§Ù„ÙƒÙ„ÙŠ: ${durationMs.toFixed(2)} Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ©`);

    } catch (err) {
      console.error('âŒ ÙØ´Ù„ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ø´ÙƒÙ„ Ø¹Ø§Ù…:', err);
    } finally {
      console.log('\n--- ğŸ Ø§Ù†ØªÙ‡Ù‰ ØªØ´ØºÙŠÙ„ Ø£Ø¯Ø§Ø© Ø§Ù„Ø¥ØµÙ„Ø§Ø­ ---');
    }
  }

  /**
   * ÙŠØ¬Ù…Ø¹ Ù…Ø³Ø§Ø±Ø§Øª Ø¬Ù…ÙŠØ¹ Ù…Ù„ÙØ§Øª Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ Ø§Ù„Ø¯Ù„ÙŠÙ„ Ø§Ù„Ù…Ø­Ø¯Ø¯.
   * @param {string} dir - Ø§Ù„Ù…Ø³Ø§Ø± Ù„Ù„Ø¨Ø­Ø« ÙÙŠÙ‡.
   * @returns {Promise<string[]>} Ù…ØµÙÙˆÙØ© Ø¨Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø©.
   * @private
   */
  async _collectFiles(dir) {
    const entries = await fs.readdir(dir, { withFileTypes: true });
    let files = [];

    for (const entry of entries) {
      const fullPath = path.join(dir, entry.name);
      if (entry.isDirectory()) {
        files.push(...await this._collectFiles(fullPath));
      } else if (DEFAULT_FILE_EXTENSIONS.includes(path.extname(entry.name).toLowerCase())) {
        files.push(fullPath);
      }
    }
    return files;
  }

  /**
   * ÙŠØ­Ø§ÙˆÙ„ ØªØ­Ù„ÙŠÙ„ Ù…Ù„Ù ASTØŒ ÙˆÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ØªÙŠ ØªØ³Ø¨Ø¨ Ø£Ø®Ø·Ø§Ø¡.
   * @param {string} filePath - Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ù…Ù„Ù.
   * @private
   */
  async _tryAnalyze(filePath) {
    try {
      const { issues, ast, content } = await this._enhancedASTAnalysis(filePath);
      issues.forEach(issue => this.allIssues.push({ ...issue, file: path.relative(process.cwd(), filePath) }));
      return { issues, ast, content }; // Return content too for fix application
    } catch (error) {
      this.skippedFiles.push({ file: path.relative(process.cwd(), filePath), reason: error.message });
      console.warn(`âš ï¸ ØªÙ… ØªØ®Ø·Ù‘ÙŠ Ø§Ù„Ù…Ù„Ù ${path.relative(process.cwd(), filePath)} Ø¨Ø³Ø¨Ø¨ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„: ${error.message}`);
      return null;
    }
  }

  /**
   * ÙŠÙ‚ÙˆÙ… Ø¨ØªØ­Ù„ÙŠÙ„ AST Ù„Ù„Ù…Ù„Ù ÙˆÙŠØ¬Ù…Ø¹ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„.
   * @param {string} filePath - Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ù…Ù„Ù.
   * @returns {Promise<{issues: Array<object>, ast: object, content: string}>}
   * @private
   */
  async _enhancedASTAnalysis(filePath) {
    const issues = [];
    const relativePath = path.relative(process.cwd(), filePath);
    let content;

    try {
      content = await fs.readFile(filePath, 'utf8');
      if (!content.trim()) {
        issues.push(this._createIssue({
          type: 'EmptyFile', severity: SEVERITY_LEVELS.LOW,
          message: 'Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº Ø£Ùˆ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…Ø³Ø§ÙØ§Øª Ø¨ÙŠØ¶Ø§Ø¡ ÙÙ‚Ø·.',
        }));
        return { issues, ast: null, content };
      }

      const ast = parse(content, {
        sourceType: 'module', // 'script' or 'module'
        plugins: ['jsx', 'typescript'], // ÙŠØ¯Ø¹Ù… TypeScript Ùˆ JSX
        errorRecovery: true, // ÙŠÙƒÙ…Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø­ØªÙ‰ Ù„Ùˆ ÙˆØ¬Ø¯ Ø£Ø®Ø·Ø§Ø¡
      });

      if (ast.errors?.length > 0) {
        ast.errors.forEach(err => {
          issues.push(this._createIssue({
            type: 'SyntaxError', severity: SEVERITY_LEVELS.CRITICAL,
            message: 'Ø®Ø·Ø£ ØªØ±ÙƒÙŠØ¨ÙŠ (Syntax Error) ØªÙ… Ø§ÙƒØªØ´Ø§ÙÙ‡.',
            details: err.message, line: err.loc?.line, column: err.loc?.column,
            codeSnippet: this._getCodeSnippet(content, err.loc),
          }));
        });
      }

      // AST Traversal for deeper analysis
      // Note: traverse.default is used due to commonJS vs ESModule interop
      if (traverse && typeof traverse.default === 'function') {
        traverse.default(ast, this._createTraversalVisitors(content, issues));
      } else {
        console.warn(`WARN: @babel/traverse not available or not a function. Skipping AST traversal for ${relativePath}.`);
      }


      return { issues, ast, content };
    } catch (error) {
      throw new AnalysisError(`ÙØ´Ù„ ØªØ­Ù„ÙŠÙ„ AST Ù„Ù„Ù…Ù„Ù: ${error.message}`, relativePath, 0);
    }
  }

  /**
   * ÙŠÙ†Ø´Ø¦ ÙƒØ§Ø¦Ù† Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø¨Ø´ÙƒÙ„ Ù…ÙˆØ­Ø¯.
   * @param {object} issueData
   * @returns {object}
   * @private
   */
  _createIssue(issueData) {
    return {
      fixable: issueData.fixable || false, // Ù‡Ù„ ÙŠÙ…ÙƒÙ† Ø¥ØµÙ„Ø§Ø­Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ØŸ
      suggestedFix: issueData.suggestedFix || null, // Ø§Ù‚ØªØ±Ø§Ø­ Ø§Ù„Ø¥ØµÙ„Ø§Ø­ (Ù†ØµØŒ Ø£Ùˆ ÙƒÙˆØ¯)
      ...issueData,
    };
  }

  /**
   * ÙŠÙˆÙ„Ø¯ Ø²ÙˆØ§Ø± AST Ù„Ø§ÙƒØªØ´Ø§Ù Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ù…Ø´Ø§ÙƒÙ„.
   * @param {string} fileContent - Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø£ØµÙ„ÙŠ.
   * @param {Array<object>} issues - Ù…ØµÙÙˆÙØ© Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ù…ÙƒØªØ´ÙØ©.
   * @returns {object}
   * @private
   */
  _createTraversalVisitors(fileContent, issues) {
    const self = this; // Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ù…Ø±Ø¬Ø¹ Ù„Ù„ÙƒØ§Ø¦Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ

    return {
      // --- Structural and Code Style Issues ---
      EmptyStatement(path) {
        // Ø§ÙƒØªØ´Ø§Ù Ø§Ù„ÙÙˆØ§ØµÙ„ Ø§Ù„Ù…Ù†Ù‚ÙˆØ·Ø© Ø§Ù„Ø²Ø§Ø¦Ø¯Ø©
        const loc = path.node.loc;
        if (loc) {
          issues.push(self._createIssue({
            type: 'EmptyStatement', severity: SEVERITY_LEVELS.LOW,
            message: 'ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙØ§ØµÙ„Ø© Ù…Ù†Ù‚ÙˆØ·Ø© Ø²Ø§Ø¦Ø¯Ø©.',
            line: loc.start.line, column: loc.start.column,
            codeSnippet: self._getCodeSnippet(fileContent, loc),
            fixable: true, suggestedFix: '' // Ø§Ù‚ØªØ±Ø§Ø­: Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙØ§ØµÙ„Ø© Ø§Ù„Ù…Ù†Ù‚ÙˆØ·Ø©
          }));
        }
      },

      FunctionDeclaration(path) {
        // Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø·ÙˆÙŠÙ„Ø©
        if (self._isFunctionTooLong(path.node)) {
          issues.push(self._createIssue({
            type: 'LongFunction', severity: SEVERITY_LEVELS.MEDIUM,
            message: 'Ø§Ù„Ø¯Ø§Ù„Ø© ØªØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø£Ù‚ØµÙ‰ Ø§Ù„Ù…ÙˆØµÙ‰ Ø¨Ù‡. ÙŠÙØ¶Ù„ ØªÙ‚Ø³ÙŠÙ…Ù‡Ø§.',
            line: path.node.loc?.start.line, column: path.node.loc?.start.column,
            codeSnippet: self._getCodeSnippet(fileContent, path.node.loc),
            fixable: false, // Ø¹Ø§Ø¯Ø© Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥ØµÙ„Ø§Ø­ Ù‡Ø°Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨Ø´ÙƒÙ„ Ù…ÙˆØ«ÙˆÙ‚
            suggestedFix: '// CONSIDER REFACTORING: This function is too long. Break it into smaller, more focused functions for better readability and maintainability.'
          }));
        }
      },

      // --- Security and Best Practices Issues ---
      CallExpression(path) {
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… eval
        if (path.node.callee?.name === 'eval') {
          issues.push(self._createIssue({
            type: 'SecurityRisk-Eval', severity: SEVERITY_LEVELS.HIGH,
            message: 'Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯Ø§Ù„Ø© `eval()` Ù…Ø­Ø¸ÙˆØ± Ø£Ùˆ ØºÙŠØ± Ù…ÙˆØµÙ‰ Ø¨Ù‡ Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø£Ù…Ù†ÙŠØ©.',
            line: path.node.loc?.start.line, column: path.node.loc?.start.column,
            codeSnippet: self._getCodeSnippet(fileContent, path.node.loc),
            fixable: false, // Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥ØµÙ„Ø§Ø­Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¯ÙˆÙ† Ù…Ø¹Ø±ÙØ© Ø§Ù„Ù†ÙŠØ© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©
            suggestedFix: '// SECURITY ALERT: Avoid using eval(). Consider safer alternatives like parsing JSON or dynamic function calls with known inputs.'
          }));
        }
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… APIs Ù…Ù‡Ù…Ù„Ø©
        self._checkForDeprecatedAPIs(path, issues, fileContent);
      },

      MemberExpression(path) {
        // ÙˆØµÙˆÙ„ Ù…Ø¨Ø§Ø´Ø± Ù„Ù€ window.document ÙÙŠ Ø³ÙŠØ§Ù‚ Apps Script (Node.js mock for it)
        if (path.node.object?.name === 'window' && path.node.property?.name === 'document') {
          issues.push(self._createIssue({
            type: 'RestrictedAccess-DOM', severity: SEVERITY_LEVELS.HIGH,
            message: 'Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø¥Ù„Ù‰ `window.document` ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡ ÙÙŠ Google Apps Script. Ø§Ø³ØªØ®Ø¯Ù… `HtmlService` Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø°Ù„Ùƒ.',
            line: path.node.loc?.start.line, column: path.node.loc?.start.column,
            codeSnippet: self._getCodeSnippet(fileContent, path.node.loc),
            fixable: false,
            suggestedFix: '// APPS SCRIPT CONTEXT: Direct DOM manipulation via `window.document` is not allowed. Use `HtmlService` or pass data to client-side JS.'
          }));
        }
      },

      // --- Contextual and Scope Analysis (Simulated) ---
      VariableDeclarator(path) {
        // Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø© (Ø¨Ø¯ÙˆÙ† var/let/const)
        // Ù‡Ø°Ø§ ÙŠØªØ·Ù„Ø¨ ØªØ­Ù„ÙŠÙ„Ø§Ù‹ Ù…Ø¹Ù‚Ø¯Ø§Ù‹ Ù„Ù„Ù…Ø¬Ø§Ù„ (scope), Ù‡Ù†Ø§ Ù‡Ùˆ Ù…Ø­Ø§ÙƒØ§Ø© Ø¨Ø³ÙŠØ·Ø©
        if (path.node.id.name && !path.scope.hasBinding(path.node.id.name) && path.scope.parent === null) {
          // Ø§Ù„Ù…ØªØºÙŠØ± Ù…Ø¹Ø±Ù‘Ù ÙÙŠ Ø§Ù„Ø¬Ø°Ø± ÙˆÙ„ÙŠØ³ Ù„Ù‡ `var`, `let`, `const`
          // Ù‡Ø°Ø§ Ø§ÙØªØ±Ø§Ø¶ÙŠ ÙˆÙ‚Ø¯ ÙŠÙƒÙˆÙ† Ù„Ù‡ Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ§Øª ÙƒØ§Ø°Ø¨Ø©
          issues.push(self._createIssue({
            type: 'GlobalVariableLeak', severity: SEVERITY_LEVELS.MEDIUM,
            message: `Ø§Ù„Ù…ØªØºÙŠØ± '${path.node.id.name}' Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ù…ØªØºÙŠØ±Ù‹Ø§ Ø¹Ø§Ù„Ù…ÙŠÙ‹Ø§ ØºÙŠØ± Ù…Ù‚ØµÙˆØ¯ (Global Leak).`,
            line: path.node.loc?.start.line, column: path.node.loc?.start.column,
            codeSnippet: self._getCodeSnippet(fileContent, path.node.loc),
            fixable: false,
            suggestedFix: `// CONSIDER: Ensure '${path.node.id.name}' is declared with 'const', 'let', or 'var' to prevent global scope pollution.`
          }));
        }
      },
    };
  }

  /**
   * ÙŠØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¯Ø§Ù„Ø© Ø·ÙˆÙŠÙ„Ø© Ø¬Ø¯Ø§Ù‹.
   * @param {object} node - Ø¹Ù‚Ø¯Ø© Ø§Ù„Ø¯Ø§Ù„Ø© (FunctionDeclaration, FunctionExpression).
   * @returns {boolean}
   * @private
   */
  _isFunctionTooLong(node) {
    const MAX_FUNCTION_LINES = 50; // Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ø¹Ø¯Ø¯ Ø£Ø³Ø·Ø± Ø§Ù„Ø¯Ø§Ù„Ø©
    const loc = node.loc;
    if (loc && loc.end && loc.start) {
      return (loc.end.line - loc.start.line) > MAX_FUNCTION_LINES;
    }
    return false;
  }

  /**
   * ÙŠØ¬Ù„Ø¨ Ù…Ù‚ØªØ·Ù Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø®Ø·Ø£.
   * @param {string} content - Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„Ù Ø§Ù„ÙƒØ§Ù…Ù„.
   * @param {object} loc - ÙƒØ§Ø¦Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ (location) Ù…Ù† AST.
   * @returns {string|null} Ù…Ù‚ØªØ·Ù Ø§Ù„ÙƒÙˆØ¯.
   * @private
   */
  _getCodeSnippet(content, loc) {
    if (!loc || !loc.start || !loc.end) return null;
    const lines = content.split('\n');
    // Ø¬Ù„Ø¨ Ø³Ø·Ø± ÙˆØ§Ø­Ø¯ Ù‚Ø¨Ù„ØŒ Ø³Ø·Ø± Ø§Ù„Ø®Ø·Ø£ØŒ ÙˆØ³Ø·Ø± ÙˆØ§Ø­Ø¯ Ø¨Ø¹Ø¯
    const startLineIdx = Math.max(0, loc.start.line - 2);
    const endLineIdx = Math.min(lines.length, loc.end.line + 1);
    const snippetLines = lines.slice(startLineIdx, endLineIdx);

    // Ø¥Ø¶Ø§ÙØ© Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø£Ø³Ø·Ø± Ù„ØªØ³Ù‡ÙŠÙ„ Ø§Ù„ØªØ­Ø¯ÙŠØ¯
    return snippetLines.map((line, index) => {
      const lineNumber = startLineIdx + index + 1;
      const isErrorLine = (lineNumber >= loc.start.line && lineNumber <= loc.end.line);
      return `${isErrorLine ? ' >' : '  '} ${lineNumber.toString().padStart(4, ' ')} | ${line}`;
    }).join('\n');
  }

  /**
   * ÙŠØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… APIs Ø§Ù„Ù…Ù‡Ù…Ù„Ø©.
   * @param {object} path - Ù…Ø³Ø§Ø± AST.
   * @param {Array<object>} issues - Ù…ØµÙÙˆÙØ© Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ù…ÙƒØªØ´ÙØ©.
   * @param {string} fileContent - Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„Ù Ø§Ù„ÙƒØ§Ù…Ù„.
   * @private
   */
  _checkForDeprecatedAPIs(path, issues, fileContent) {
    const deprecatedAPIs = ['escape', 'unescape', 'Buffer.prototype.slice', 'new Buffer']; // Ø£Ù…Ø«Ù„Ø©
    if (path.node.callee?.name && deprecatedAPIs.includes(path.node.callee.name)) {
      issues.push(this._createIssue({
        type: 'DeprecatedAPI', severity: SEVERITY_LEVELS.MEDIUM,
        message: `Ø§Ø³ØªØ®Ø¯Ø§Ù… API Ù…Ù‡Ù…Ù„Ø©: "${path.node.callee.name}"`,
        line: path.node.loc?.start.line, column: path.node.loc?.start.column,
        codeSnippet: this._getCodeSnippet(fileContent, path.node.loc),
        fixable: false,
        suggestedFix: `// DEPRECATED: Consider using 'encodeURIComponent' / 'decodeURIComponent' or more modern Buffer APIs.`
      }));
    }
  }

  /**
   * ÙŠØ·Ø¨Ù‚ Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ù‚ØªØ±Ø­ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ù.
   * Ù‡Ø°Ø§ ØªÙ†ÙÙŠØ° Ù…Ø¨Ø³Ø· ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø³Ù„Ø§Ø³Ù„. Ù„Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø¹Ù‚Ø¯Ø©ØŒ ÙŠØªØ·Ù„Ø¨ Ù…Ø¹Ø§Ù„Ø¬Ø© AST Ø¹Ù…ÙŠÙ‚Ø©.
   * @param {object} issue - ÙƒØ§Ø¦Ù† Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¥ØµÙ„Ø§Ø­Ù‡Ø§.
   * @returns {Promise<void>}
   * @private
   */
  async _applyFix(issue) {
    if (!issue.fixable || !issue.suggestedFix || !issue.file || !issue.line) {
      throw new Error(`Cannot apply fix for unfixable, missing fix, or incomplete issue: ${JSON.stringify(issue)}`);
    }

    const filePath = path.join(process.cwd(), issue.file);
    let fileContent;
    try {
      fileContent = await fs.readFile(filePath, 'utf8');
    } catch (e) {
      throw new FixApplicationError(`Failed to read file ${filePath} for fix application.`, e);
    }

    const backupPath = await this._createRestorePoint(filePath); // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ù‚Ø·Ø© Ø§Ø³ØªØ¹Ø§Ø¯Ø©

    let newContent = fileContent;

    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥ØµÙ„Ø§Ø­Ø§Øª Ø§Ù„Ø¨Ø³ÙŠØ·Ø© (Ù…Ø«Ù„ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙÙˆØ§ØµÙ„ Ø§Ù„Ù…Ù†Ù‚ÙˆØ·Ø© Ø§Ù„Ø²Ø§Ø¦Ø¯Ø©)
    if (issue.type === 'EmptyStatement' && issue.suggestedFix === '') {
        const lines = newContent.split('\n');
        if (lines[issue.line - 1]) {
            lines[issue.line - 1] = lines[issue.line - 1].replace(/;$/, ''); // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙØ§ØµÙ„Ø© Ø§Ù„Ù…Ù†Ù‚ÙˆØ·Ø© ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø³Ø·Ø±
            newContent = lines.join('\n');
        }
    } else {
        // Ù„Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø£ÙƒØ«Ø± ØªØ¹Ù‚ÙŠØ¯Ù‹Ø§ØŒ Ø³Ù†ÙƒØªÙÙŠ Ø¨Ø¥Ø¶Ø§ÙØ© ØªØ¹Ù„ÙŠÙ‚ Ø£Ùˆ ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø³ÙŠØ·
        // Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡ Ø³ÙŠØªØ·Ù„Ø¨ Ù…Ù†Ø·Ù‚Ù‹Ø§ Ø£ÙƒØ«Ø± ØªØ¹Ù‚ÙŠØ¯Ù‹Ø§ ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ AST Ù…Ø¨Ø§Ø´Ø±Ø© Ù„ÙŠÙƒÙˆÙ† Ø¢Ù…Ù†Ù‹Ø§
        // ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø«Ø§Ù„ØŒ Ø³Ù†Ø¶Ø¹ ØªØ¹Ù„ÙŠÙ‚Ø§Ù‹ ÙÙŠ Ø³Ø·Ø± Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø§Ù‚ØªØ±Ø§Ø­ Ø¥ØµÙ„Ø§Ø­ Ù†ØµÙŠ
        const lines = newContent.split('\n');
        if (lines[issue.line - 1] && typeof issue.suggestedFix === 'string' && issue.suggestedFix.startsWith('//')) {
            lines[issue.line - 1] = `${issue.suggestedFix} ${lines[issue.line - 1]}`;
            newContent = lines.join('\n');
        } else if (issue.codeSnippet && issue.suggestedFix) {
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù…Ù‚ØªØ·Ù Ø¨Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…Ù‚ØªØ±Ø­
            newContent = newContent.replace(issue.codeSnippet.trim(), issue.suggestedFix.trim());
        }
    }

    try {
      await fs.writeFile(filePath, newContent, 'utf8');
      this.appliedFixes.push({ file: issue.file, type: issue.type, backup: backupPath });
      console.log(`âœ… ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ù„Ù€ ${issue.type} ÙÙŠ ${issue.file} (Ù†Ù‚Ø·Ø© Ø§Ø³ØªØ¹Ø§Ø¯Ø©: ${backupPath}).`);
    } catch (e) {
      console.error(`âŒ ÙØ´Ù„ Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ù„Ù Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­: ${filePath}. Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ±Ø§Ø¬Ø¹...`);
      await fs.copyFile(backupPath, filePath); // Ø§Ù„ØªØ±Ø§Ø¬Ø¹
      await fs.unlink(backupPath); // Ø­Ø°Ù Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„ÙØ§Ø´Ù„Ø©
      throw new FixApplicationError(`Failed to write fixed content to ${filePath}. Rolled back.`, e);
    }
  }

  /**
   * ÙŠÙ†Ø´Ø¦ Ù†Ù‚Ø·Ø© Ø§Ø³ØªØ¹Ø§Ø¯Ø© (backup) Ù„Ù„Ù…Ù„Ù Ù‚Ø¨Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„.
   * @param {string} filePath - Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ù…Ù„Ù.
   * @returns {Promise<string>} Ù…Ø³Ø§Ø± Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©.
   * @private
   */
  async _createRestorePoint(filePath) {
    const backupPath = `${filePath}.bak`;
    try {
      await fs.copyFile(filePath, backupPath);
      return backupPath;
    } catch (error) {
      throw new FixApplicationError(`ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ù†Ù‚Ø·Ø© Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù„Ù€: ${filePath}`, error);
    }
  }

  /**
   * ÙŠÙˆÙ„Ø¯ ØªÙ‚Ø±ÙŠØ± Markdown Ø´Ø§Ù…Ù„.
   * @param {Array<object>} issues - Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ù…ÙƒØªØ´ÙØ©.
   * @returns {string} Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨ØµÙŠØºØ© Markdown.
   * @private
   */
  _generateMarkdownReport(issues) {
    let md = `# ğŸ› ï¸ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ÙÙ†ÙŠ - ${new Date().toLocaleString('ar-SA')}\n\n`;
    md += `**Ø§Ù„Ø­Ø§Ù„Ø©:** ${this.dryRun ? 'ÙˆØ¶Ø¹ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ (Ù„Ù… ØªÙØ·Ø¨Ù‚ Ø¥ØµÙ„Ø§Ø­Ø§Øª)' : `ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥ØµÙ„Ø§Ø­Ø§Øª Ù„Ù€ ${this.appliedFixes.length} Ù…Ø´ÙƒÙ„Ø©.`}\n`;
    md += `**Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ù…ÙƒØªØ´ÙØ©:** ${this.allIssues.length}\n`;
    md += `**Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ØªÙŠ ØªÙ… ØªØ®Ø·Ù‘ÙŠÙ‡Ø§:** ${this.skippedFiles.length}\n\n`;

    if (issues.length > 0) {
      md += `## âš ï¸ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ù…ÙƒØªØ´ÙØ© (${issues.length})\n\n`;
      md += `| Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© | Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©       | Ø§Ù„Ø®Ø·ÙˆØ±Ø© | Ø§Ù„Ù…Ù„Ù               | Ø§Ù„Ø³Ø·Ø± | Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø¥ØµÙ„Ø§Ø­ | Ø§Ù„ØªÙØ§ØµÙŠÙ„ |\n`;
      md += `|----------|--------------------|----------|---------------------|--------|-------------|-----------|\n`;
      issues.forEach((issue, i) => {
        md += `| #${i + 1} | ${issue.type} | ${issue.severity} | ${issue.file} | ${issue.line ?? '-'} | ${issue.fixable ? 'âœ…' : 'ğŸš«'} | ${issue.message} |\n`;
      });

      md += `\n\n## ğŸ“ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ ÙˆØ§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø§Ù„Ø¥ØµÙ„Ø§Ø­\n\n`;
      issues.forEach(issue => {
        md += `### ${issue.type} ÙÙŠ ${issue.file} (Ø§Ù„Ø³Ø·Ø±: ${issue.line ?? '-'}) - Ø§Ù„Ø®Ø·ÙˆØ±Ø©: ${issue.severity}\n`;
        md += `**Ø§Ù„ÙˆØµÙ:** ${issue.message}\n`;
        if (issue.details) md += `**ØªÙØ§ØµÙŠÙ„ ÙÙ†ÙŠØ©:** ${issue.details}\n`;
        if (issue.codeSnippet) {
          md += `\n\`\`\`javascript\n${issue.codeSnippet}\n\`\`\`\n`;
        }
        if (issue.fixable) {
          md += `**Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ:** âœ…\n`;
          if (issue.suggestedFix) {
            md += `**Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­:**\n\`\`\`\n${issue.suggestedFix}\n\`\`\`\n`;
          }
        } else {
          md += `**Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ:** ğŸš«\n`;
          if (issue.suggestedFix) {
            md += `**Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­ Ø§Ù„ÙŠØ¯ÙˆÙŠ:**\n\`\`\`\n${issue.suggestedFix}\n\`\`\`\n`;
          }
        }
        md += `\n---\n\n`;
      });
    } else {
      md += `## âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§ÙƒÙ„ ØªØ³ØªØ¯Ø¹ÙŠ Ø§Ù„ØªÙ‚Ø±ÙŠØ±! Ø¹Ù…Ù„ Ø±Ø§Ø¦Ø¹.\n\n`;
    }

    if (this.skippedFiles.length > 0) {
      md += `## âš ï¸ Ù…Ù„ÙØ§Øª ØªÙ… ØªØ®Ø·Ù‘ÙŠÙ‡Ø§ (${this.skippedFiles.length})\n\n`;
      md += `| Ø§Ù„Ù…Ù„Ù                   | Ø§Ù„Ø³Ø¨Ø¨                                        |\n`;
      md += `|--------------------------|-----------------------------------------------|\n`;
      this.skippedFiles.forEach(skipped => {
        md += `| ${skipped.file} | ${skipped.reason} |\n`;
      });
      md += `\n\n`;
    }

    if (this.appliedFixes.length > 0) {
      md += `## ğŸ”§ Ø§Ù„Ø¥ØµÙ„Ø§Ø­Ø§Øª Ø§Ù„ØªÙŠ ØªÙ… ØªØ·Ø¨ÙŠÙ‚Ù‡Ø§ (${this.appliedFixes.length})\n\n`;
      md += `| Ø§Ù„Ù…Ù„Ù                   | Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©       | Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© |\n`;
      md += `|--------------------------|--------------------|----------------|\n`;
      this.appliedFixes.forEach(fix => {
        md += `| ${fix.file} | ${fix.type} | ${fix.backup} |\n`;
      });
      md += `\n\n`;
    }

    md += `\n\n--- Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªÙ‚Ø±ÙŠØ± ---`;
    return md;
  }
}

// --- Usage Example and CLI Integration ---
// Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡ ÙŠØªÙ… ØªØ´ØºÙŠÙ„Ù‡ Ø¹Ù†Ø¯ ØªÙ†ÙÙŠØ° Ø§Ù„Ù…Ù„Ù ÙÙŠ Node.js
async function runAdvancedRepair() {
  const args = process.argv.slice(2);
  const applyFixes = args.includes('--apply-fixes') || args.includes('-f');
  const srcDirArg = args.find(arg => arg.startsWith('--src-dir='));
  const reportDirArg = args.find(arg => arg.startsWith('--report-dir='));

  const options = {
    applyFixes: applyFixes,
    srcDir: srcDirArg ? srcDirArg.split('=')[1] : SRC_DIR,
    reportDir: reportDirArg ? reportDirArg.split('=')[1] : REPORT_DIR,
  };

  const agent = new AdvancedRepairAgent();
  await agent.scanAndReport(options);
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø¹Ù†Ø¯ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ù…Ù„Ù Ù…Ø¨Ø§Ø´Ø±Ø©
if (require.main === module) {
  runAdvancedRepair();
}

// *************************************************************************************************
// --- END OF FILE: src/dev_tools/advanced_repair.js ---
// *************************************************************************************************