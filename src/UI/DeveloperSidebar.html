// *************************************************************************************************
// --- START OF FILE: ui/DeveloperSidebar.html ---
// *************************************************************************************************
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G-Assistant Developer Tools</title>
    <style>
        :root {
            --bg-primary: #111827; --bg-secondary: #1f2937; --bg-tertiary: #374151;
            --text-primary: #f9fafb; --text-secondary: #d1d5db; --text-accent: #60a5fa; /* Lighter blue for accent */
            --border-color: #4b5563; --accent-color: #3b82f6; --accent-hover: #2563eb;
            --error-color: #f87171; --success-color: #4ade80;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-primary); color: var(--text-primary);
            margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column;
        }
        .tabs { display: flex; background-color: var(--bg-secondary); border-bottom: 1px solid var(--border-color); overflow-x: auto; flex-shrink: 0; }
        .tab-button {
            flex-shrink: 0; padding: 0.75rem 1rem; border: none; background: none; color: var(--text-secondary);
            font-size: 0.85rem; font-weight: 600; cursor: pointer; border-bottom: 3px solid transparent;
            transition: color 0.2s, border-color 0.2s; white-space: nowrap;
        }
        .tab-button.active { color: var(--text-accent); border-bottom-color: var(--accent-color); }
        .tab-content { display: none; padding: 1rem; flex-grow: 1; overflow-y: auto; }
        .tab-content.active { display: flex; flex-direction: column; }
        .form-group { margin-bottom: 1rem; }
        label { display: block; font-weight: 500; margin-bottom: 0.5rem; color: var(--text-secondary); font-size: 0.9em;}
        input, textarea, select {
            width: 100%; padding: 0.5rem; background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color); color: var(--text-primary);
            border-radius: 6px; box-sizing: border-box; font-size: 14px;
        }
        textarea { min-height: 120px; font-family: 'SF Mono', 'Fira Code', 'Fira Mono', 'Roboto Mono', monospace; line-height: 1.4; }
        button {
            width: 100%; padding: 0.75rem; background-color: var(--accent-color); color: var(--text-primary);
            border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: background-color 0.2s;
            margin-top: 0.5rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem;
        }
        button:hover:not(:disabled) { background-color: var(--accent-hover); }
        button:disabled { background-color: var(--bg-tertiary); cursor: not-allowed; opacity: 0.6; }
        .result-area {
            margin-top: 1rem; padding: 1rem; background-color: var(--bg-secondary);
            border-radius: 6px; flex-grow: 1; overflow-y: auto; white-space: pre-wrap; font-size: 0.9em;
        }
        .result-area .code-block { position: relative; }
        .result-area .copy-btn {
            position: absolute; top: 0.5rem; right: 0.5rem; background: var(--bg-tertiary);
            color: var(--text-secondary); border: 1px solid var(--border-color);
            padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem;
        }
        .result-area .copy-btn:hover { background: var(--accent-color); color: var(--text-primary); }
        .feedback-item {
            border-left: 3px solid var(--accent-color); padding: 0.75rem 1rem;
            margin-bottom: 1rem; background-color: var(--bg-tertiary); border-radius: 4px;
        }
        .feedback-item h5 { margin: 0 0 0.5rem 0; color: var(--text-accent); }
        pre, code { background-color: var(--bg-primary) !important; padding: 0.75rem; border-radius: 4px; overflow-x: auto;}
        .message { font-style: italic; color: var(--text-secondary); text-align: center; padding: 1rem; }
        .button-secondary { background-color: var(--bg-tertiary); border: 1px solid var(--border-color); }
        .button-secondary:hover:not(:disabled) { background-color: var(--border-color); }
    </style>
</head>
<body>

    <div class="tabs">
        <button class="tab-button" onclick="openTab(event, 'codeGenerator')">ğŸ’¡ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯</button>
        <button class="tab-button" onclick="openTab(event, 'codeReview')">ğŸ‘¨â€ğŸ’» Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ÙƒÙˆØ¯</button>
        <button class="tab-button" onclick="openTab(event, 'projectInsights')">ğŸ“Š Ø±Ø¤Ù‰ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</button>
        <button class="tab-button" onclick="openTab(event, 'api')">ğŸ“¡ ÙˆØ§Ø¬Ù‡Ø© API</button>
        <button class="tab-button" onclick="openTab(event, 'workshop')">ğŸ§ª ÙˆØ±Ø´Ø© Ø§Ù„Ø¹Ù…Ù„</button>
        <button class="tab-button" onclick="openTab(event, 'help')">â“ Ù…Ø³Ø§Ø¹Ø¯Ø©</button>
        <button title="ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³ÙŠØ§Ù‚" style="padding: 0.5rem; border: none; background: none; color: var(--text-secondary); cursor: pointer; margin-right: auto;" onclick="fetchContext()">ğŸ”„</button>
    </div>

    <!-- Tab: Code Review -->
    <div id="codeReview" class="tab-content">
        <h3>Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ÙƒÙˆØ¯</h3>
        <div class="form-group">
            <textarea id="codeText" placeholder="Ø§Ù„ØµÙ‚ Ø§Ù„ÙƒÙˆØ¯ Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± Ø§Ù„Ø¬Ù„Ø¨..."></textarea>
            <button class="button-secondary" onclick="getCodeFromCell()">ğŸ“¥ Ø¬Ù„Ø¨ Ù…Ù† Ø§Ù„Ø®Ù„ÙŠØ©</button>
        </div>
        <div class="form-group">
            <label for="reviewType">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</label>
            <select id="reviewType">
                <option value="general">Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¹Ø§Ù…Ø©</option>
                <option value="performance">ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡</option>
                <option value="security">ÙØ­Øµ Ø§Ù„Ø£Ù…Ø§Ù†</option>
            </select>
        </div>
        <button id="reviewBtn" onclick="runCodeReview()">âœ¨ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ÙƒÙˆØ¯</button>
        <div id="reviewResult" class="result-area" style="display:none;"></div>
    </div>

    <!-- Tab: Code Generator -->
    <div id="codeGenerator" class="tab-content">
        <h3>ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯ ÙˆØ§Ù„ØµÙŠØº</h3>
        <div class="form-group">
            <label for="promptText">ØµÙ Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø£Ùˆ Ø§Ù„ØµÙŠØºØ© Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯Ù‡Ø§</label>
            <textarea id="promptText" placeholder="Ù…Ø«Ø§Ù„: Ø£Ù†Ø´Ø¦ Ø¯Ø§Ù„Ø© Ù„ÙØ±Ø² Ø§Ù„Ø¹Ù…ÙˆØ¯ C ØªØµØ§Ø¹Ø¯ÙŠÙ‹Ø§... Ø£Ùˆ: Ø·Ø¨Ù‚ ØµÙŠØºØ© VLOOKUP Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ù‚ÙŠÙ… Ù…Ù† ÙˆØ±Ù‚Ø© 'Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'..."></textarea>
        </div>
        <button id="generateBtn" onclick="runCodeGeneration()">âœ¨ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯</button>
        <div id="generateResult" class="result-area" style="display:none;"></div>
    </div>

    <!-- Tab: Project Insights -->
    <div id="projectInsights" class="tab-content">
        <h3>ØªØ­Ù„ÙŠÙ„ Ø´Ø§Ù…Ù„ Ù„Ù„Ù…Ø´Ø±ÙˆØ¹</h3>
        <div class="form-group">
            <label for="projectQuery">Ø§ÙƒØªØ¨ Ø§Ø³ØªØ¹Ù„Ø§Ù…Ùƒ Ø§Ù„ØªØ­Ù„ÙŠÙ„ÙŠ</label>
            <input type="text" id="projectQuery" placeholder="Ù…Ø«Ø§Ù„: Ø§Ø¨Ø­Ø« Ø¹Ù† ÙƒÙ„ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙŠ Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ JSDoc">
        </div>
        <button id="insightsBtn" onclick="runProjectAnalysis()">ğŸ” ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø¢Ù†</button>
        <div id="insightsResult" class="result-area" style="display:none;"></div>
    </div>
    
    <!-- Tab: API -->
    <div id="api" class="tab-content">
        <h3>ØªÙˆØ«ÙŠÙ‚ ÙˆØ§Ø¬Ù‡Ø© API</h3>
        <p class="text-xs text-gray-400">Ø§Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ø§ Ø§Ù„ØªÙˆØ«ÙŠÙ‚ Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø®Ø¯Ù…Ø§Øª G-Assistant Ù…Ù† ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø®Ø§Ø±Ø¬ÙŠØ©.</p>
        <button id="apiSchemaBtn" onclick="getApiSchema()">ğŸ“‹ Ø¹Ø±Ø¶ ØªÙˆØ«ÙŠÙ‚ API</button>
        <div id="apiSchemaResult" class="result-area" style="display:none;"></div>
    </div>

    <!-- Tab: Developer Workshop -->
    <div id="workshop" class="tab-content">
        <h3>ÙˆØ±Ø´Ø© Ø¹Ù…Ù„ Ø§Ù„Ù…Ø·ÙˆØ±ÙŠÙ†</h3>
        <p class="text-xs text-gray-400">Ø¹Ø±Ø¶ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª ÙˆØ§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„ØªÙŠ ØªÙ†ØªØ¸Ø± Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©.</p>
        <button id="workshopBtn" onclick="viewWorkshop()">ğŸ”„ Ø¹Ø±Ø¶ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ÙˆØ±Ø´Ø©</button>
        <div id="workshopResult" class="result-area" style="display:none;"></div>
    </div>

    <!-- Tab: Help -->
    <div id="help" class="tab-content">
        <h3>Ø¯Ù„ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„Ø³Ø±ÙŠØ¹</h3>
        <p>Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ ÙˆØ±Ø´Ø© Ø¹Ù…Ù„ Ø§Ù„Ù…Ø·ÙˆØ±ÙŠÙ†! Ø¥Ù„ÙŠÙƒ Ø¯Ù„ÙŠÙ„ Ø³Ø±ÙŠØ¹ Ù„Ù„Ø¨Ø¯Ø¡:</p>
        <div class="feedback-item">
            <h5>ğŸ’¡ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯</h5>
            <p>Ø§ÙƒØªØ¨ ÙˆØµÙÙ‹Ø§ Ù„Ù„ÙˆØ¸ÙŠÙØ© Ø£Ùˆ Ø§Ù„ØµÙŠØºØ© Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯Ù‡Ø§ (Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø£Ùˆ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©) ÙˆØ§Ø¶ØºØ· Ø¹Ù„Ù‰ "ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯". Ø³ÙŠÙ‚ÙˆÙ… Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…Ù‚ØªØ±Ø­ Ù…Ø¹ Ø´Ø±Ø­ Ù„Ù‡.</p>
        </div>
        <div class="feedback-item">
            <h5>ğŸ‘¨â€ğŸ’» Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ÙƒÙˆØ¯</h5>
            <p>Ø§Ù„ØµÙ‚ Ø£ÙŠ Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ Ù…Ø±Ø¨Ø¹ Ø§Ù„Ù†ØµØŒ Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© (Ø¹Ø§Ù…Ø©ØŒ Ø£Ø¯Ø§Ø¡ØŒ Ø£Ù…Ø§Ù†)ØŒ Ø«Ù… Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ÙƒÙˆØ¯" Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªÙ‚ÙŠÙŠÙ… ÙˆØ§Ù‚ØªØ±Ø§Ø­Ø§Øª Ù„Ù„ØªØ­Ø³ÙŠÙ†.</p>
        </div>
        <div class="feedback-item">
            <h5>ğŸ“Š Ø±Ø¤Ù‰ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</h5>
            <p>Ø§Ø·Ø±Ø­ Ø£Ø³Ø¦Ù„Ø© Ø­ÙˆÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø£ÙƒÙ…Ù„Ù‡. Ù…Ø«Ø§Ù„: "Ø§Ø¨Ø­Ø« Ø¹Ù† ÙƒÙ„ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙŠ Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ØªÙˆØ«ÙŠÙ‚" Ø£Ùˆ "Ù…Ø§ Ù‡ÙŠ Ø£ÙƒØ«Ø± Ø§Ù„ÙˆØ­Ø¯Ø§Øª ØªØ¹Ù‚ÙŠØ¯Ù‹Ø§ØŸ".</p>
        </div>
        <div class="feedback-item">
            <h5>ğŸ§ª ÙˆØ±Ø´Ø© Ø§Ù„Ø¹Ù…Ù„</h5>
            <p>Ù‡Ù†Ø§ ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø§Ù„Ù†Ø§ØªØ¬Ø© Ø¹Ù† Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø§Øª Ø§Ù„Ø¯ÙˆØ±ÙŠØ© Ù„Ù„ÙƒÙˆØ¯. ÙŠÙ…ÙƒÙ†Ùƒ Ù…Ø±Ø§Ø¬Ø¹ØªÙ‡Ø§ ÙˆØªØ·Ø¨ÙŠÙ‚Ù‡Ø§ ÙÙŠ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„.</p>
        </div>
    </div>

    <script>
        let loadingInterval = null;

        // --- Core UI Functions ---
        function openTab(evt, tabName) {
            document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(tb => tb.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            evt.currentTarget.classList.add('active');
        }

        function setLoading(btn, resultArea, isLoading, originalText) {
            btn.disabled = isLoading;
            btn.innerHTML = isLoading ? 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...' : originalText;

            if (loadingInterval) {
                clearInterval(loadingInterval);
                loadingInterval = null;
            }

            if (isLoading) {
                resultArea.style.display = 'block';
                const messages = [
                    "Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨...",
                    "Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬...",
                    "Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ÙŠÙÙƒØ± Ø§Ù„Ø¢Ù†...",
                    "Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø¯...",
                    "Ø§Ù„Ù„Ù…Ø³Ø§Øª Ø§Ù„Ø£Ø®ÙŠØ±Ø©..."
                ];
                let messageIndex = 0;
                resultArea.innerHTML = `<p class="message">${messages[messageIndex]}</p>`;
                loadingInterval = setInterval(() => {
                    messageIndex = (messageIndex + 1) % messages.length;
                    resultArea.innerHTML = `<p class="message">${messages[messageIndex]}</p>`;
                }, 1800); // Change message every 1.8 seconds
            }
        }

        function handleFailure(btn, resultArea, originalText, error) {
            setLoading(btn, resultArea, false, originalText);
            resultArea.innerHTML = `<p style="color:var(--error-color);"><b>Ø®Ø·Ø£:</b><br>${error.message}</p>`;
        }
        
        // --- Context-Aware UI Logic ---
        function fetchContext() {
            google.script.run
                .withSuccessHandler(res => {
                    if (res.type === 'success' && res.data) {
                        updateUiForContext(res.data);
                    } else {
                        // On failure or no context, default to the first tab
                        document.querySelector('.tab-button').click();
                    }
                })
                .withFailureHandler(err => {
                    console.error('Failed to fetch context:', err);
                    document.querySelector('.tab-button').click(); // Default on error
                })
                .getContextualInfo();
        }

        function updateUiForContext(context) {
            console.log('Updating UI for context:', context.contextType);
            const contextTabMap = { 'DATA_SHEET': 'projectInsights', 'WORKSHOP_SHEET': 'workshop' };
            const targetTabId = contextTabMap[context.contextType] || 'codeGenerator';
            
            const targetButton = document.querySelector(`.tab-button[onclick*="'${targetTabId}'"]`);
            if (targetButton) {
                targetButton.click();
            }
        }

        function escapeHtml(unsafe) { return unsafe.replace(/&/g, "&").replace(/</g, "<").replace(/>/g, ">").replace(/"/g, """).replace(/'/g, "'"); }

        function copyToClipboard(text, button) {
            navigator.clipboard.writeText(text).then(() => {
                const originalText = button.textContent;
                button.textContent = 'ØªÙ… Ø§Ù„Ù†Ø³Ø®!';
                setTimeout(() => { button.textContent = originalText; }, 2000);
            }, (err) => {
                console.error('Failed to copy: ', err);
                alert('ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø® Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©.');
            });
        }

        // --- Tab-Specific Logic ---
        function getCodeFromCell() { google.script.run.withSuccessHandler(code => { if(code) document.getElementById('codeText').value = code; }).getCodeFromActiveCell(); }
        
        function runCodeReview() {
            const code = document.getElementById('codeText').value, type = document.getElementById('reviewType').value;
            const btn = document.getElementById('reviewBtn'), resultArea = document.getElementById('reviewResult'), originalText = 'âœ¨ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ÙƒÙˆØ¯';
            if (!code) return; 
            setLoading(btn, resultArea, true, originalText);
            google.script.run
                .withSuccessHandler(res => { setLoading(btn, resultArea, false, originalText); displayReviewResults(resultArea, res); })
                .withFailureHandler(err => handleFailure(btn, resultArea, originalText, err)).reviewCode(code, type);
        }

        function runProjectAnalysis() {
            const query = document.getElementById('projectQuery').value;
            const btn = document.getElementById('insightsBtn'), resultArea = document.getElementById('insightsResult'), originalText = 'ğŸ” ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø¢Ù†';
            if (!query) return; 
            setLoading(btn, resultArea, true, originalText);
            google.script.run
                .withSuccessHandler(res => { setLoading(btn, resultArea, false, originalText); displayInsightsResults(resultArea, res); })
                .withFailureHandler(err => handleFailure(btn, resultArea, originalText, err)).analyzeProject({userQuery: query});
        }
        
        function getApiSchema() {
            const btn = document.getElementById('apiSchemaBtn'), resultArea = document.getElementById('apiSchemaResult'), originalText = 'ğŸ“‹ Ø¹Ø±Ø¶ ØªÙˆØ«ÙŠÙ‚ API';
            setLoading(btn, resultArea, true, originalText);
            google.script.run
                .withSuccessHandler(res => { setLoading(btn, resultArea, false, originalText); displayApiSchema(resultArea, res); })
                .withFailureHandler(err => handleFailure(btn, resultArea, originalText, err)).getApiSchema();
        }

        function viewWorkshop() {
            const btn = document.getElementById('workshopBtn'), resultArea = document.getElementById('workshopResult'), originalText = 'ğŸ”„ Ø¹Ø±Ø¶ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ÙˆØ±Ø´Ø©';
            setLoading(btn, resultArea, true, originalText);
            google.script.run
                .withSuccessHandler(res => { setLoading(btn, resultArea, false, originalText); displayWorkshopItems(resultArea, res); })
                .withFailureHandler(err => handleFailure(btn, resultArea, originalText, err))
                .getWorkshopItems();
        }

        function runCodeGeneration() {
            const description = document.getElementById('promptText').value;
            const btn = document.getElementById('generateBtn'), resultArea = document.getElementById('generateResult'), originalText = 'âœ¨ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯';
            if (!description) return;
            setLoading(btn, resultArea, true, originalText);
            google.script.run
                .withSuccessHandler(res => { setLoading(btn, resultArea, false, originalText); displayGeneratedCode(resultArea, res); })
                .withFailureHandler(err => handleFailure(btn, resultArea, originalText, err)).generateCodeFromPrompt(description);
        }

        function applyFormula(formula, cellA1Notation) {
            google.script.run
                .withSuccessHandler(res => { alert(res.text); })
                .withFailureHandler(err => { alert('ÙØ´Ù„ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØµÙŠØºØ©: ' + err.message); })
                .applyFormulaToCell({ formula: formula, cellA1Notation: cellA1Notation });
        }

        // --- Result Display Functions ---
        function displayReviewResults(resultArea, response) {
            if (response.type === 'error') { resultArea.innerHTML = `<p style="color:var(--error-color);">${response.text}</p>`; return; }
            if (response.type === 'success' && response.data) {
                const data = response.data;
                let html = `<h4>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…: ${data.overallScore || 'N/A'}/100</h4><p>${data.summary || ''}</p>`;
                (data.feedbackItems || []).forEach(item => { html += `<div class="feedback-item"><h5>${item.title || ''} (${item.category || ''})</h5><p>${item.description || ''}</p>${item.codeSnippet ? `<pre><code>${escapeHtml(item.codeSnippet)}</code></pre>` : ''}</div>`; });
                if(data.patch) { html += `<div class="feedback-item"><h5>ğŸ“ ØªØ¹Ø¯ÙŠÙ„ Ù…Ù‚ØªØ±Ø­ (Patch)</h5><pre><code>${escapeHtml(data.patch)}</code></pre></div>`; }
                resultArea.innerHTML = html;
            } else { resultArea.textContent = response.text; }
        }
        
        function displayInsightsResults(resultArea, response) {
            if (response.type === 'error') { resultArea.innerHTML = `<p style="color:var(--error-color);">${response.text}</p>`; return; }
            if (response.type === 'success' && response.data) {
                const data = response.data;
                let html = `<p>${data.summary}</p>`;
                (data.suggestions || []).forEach(item => { html += `<div class="feedback-item"><h5>${item.file}</h5><p>${item.description}</p>${item.codeSnippet ? `<pre><code>${escapeHtml(item.codeSnippet)}</code></pre>` : ''}</div>`; });
                resultArea.innerHTML = html;
            } else { resultArea.textContent = response.text; }
        }

        function displayApiSchema(resultArea, response) {
            if (response.type === 'error') { resultArea.innerHTML = `<p style="color:var(--error-color);">${response.text}</p>`; return; }
            if (response.type === 'success' && response.data) {
                let html = `<h4>${response.data.description}</h4>`;
                for (const endpoint in response.data.endpoints) {
                    const details = response.data.endpoints[endpoint];
                    html += `<div class="feedback-item"><h5>${endpoint} <span style="font-weight:normal;color:var(--text-secondary)">(${details.method})</span></h5><p>${details.description}</p><pre><code>${JSON.stringify(details.params, null, 2)}</code></pre></div>`;
                }
                resultArea.innerHTML = html;
            }
        }

        function displayWorkshopItems(resultArea, response) {
            if (response.type === 'error') { resultArea.innerHTML = `<p style="color:var(--error-color);">${response.text}</p>`; return; }
            if (response.type === 'success' && response.data) {
                let html = '<h4>Ø¹Ù†Ø§ØµØ± ÙˆØ±Ø´Ø© Ø§Ù„Ø¹Ù…Ù„</h4>';
                if (response.data.length === 0) {
                    html += '<p class="message">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø­Ø§Ù„ÙŠÙ‹Ø§ ÙÙŠ ÙˆØ±Ø´Ø© Ø§Ù„Ø¹Ù…Ù„.</p>';
                } else {
                    response.data.forEach(item => {
                        html += `<div class="feedback-item">
                            <h5>${escapeHtml(item.category)} - ${escapeHtml(item.file)} <span style="font-size:0.8em; color: var(--text-secondary); float: left;">${escapeHtml(item.date)}</span></h5>
                            <p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${escapeHtml(item.status)}</p>
                            <p><strong>Ø§Ù„Ù…Ù„Ø®Øµ:</strong> ${escapeHtml(item.summary)}</p>
                            ${item.code ? `<pre><code>${escapeHtml(item.code)}</code></pre>` : ''}
                        </div>`;
                    });
                }
                resultArea.innerHTML = html;
            }
        }

        function displayGeneratedCode(resultArea, response) {
            if (response.type === 'error') { resultArea.innerHTML = `<p style="color:var(--error-color);">${response.text}</p>`; return; }
            if (response.type === 'success' && response.data) {
                const data = response.data;
                let html = `<h4>Ø´Ø±Ø­ Ø§Ù„ÙƒÙˆØ¯/Ø§Ù„ØµÙŠØºØ©:</h4><p>${escapeHtml(data.explanation)}</p>`;
                if (data.code) {
                    const codeId = 'code-' + Date.now();
                    html += `<div class="code-block"><h4>Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…Ù‚ØªØ±Ø­:</h4><button class="copy-btn" onclick="copyToClipboard(document.getElementById('${codeId}').textContent, this)">Ù†Ø³Ø®</button><pre><code id="${codeId}">${escapeHtml(data.code)}</code></pre></div>`;
                }
                if (data.isFormula) {
                    html += `<button onclick="applyFormula('${escapeHtml(data.code)}', null)">âœ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØµÙŠØºØ© Ø¹Ù„Ù‰ Ø§Ù„Ø®Ù„ÙŠØ© Ø§Ù„Ù†Ø´Ø·Ø©</button>`;
                }
                resultArea.innerHTML = html;
            } else { resultArea.textContent = response.text; }
        }

        // --- Initialization ---
        document.addEventListener("DOMContentLoaded", () => {
            fetchContext();
        });
    </script>
</body>
</html>
// *************************************************************************************************
// --- END OF FILE: ui/DeveloperSidebar.html ---
// *************************************************************************************************