/**
 * Sidebar Manager for Google Sheets Add-on
 */

export class SidebarManager {
  private loadingElement: HTMLElement | null = null;
  private resultElement: HTMLElement | null = null;
  private queryInput: HTMLInputElement | null = null;
  private submitButton: HTMLButtonElement | null = null;

  initialize(): void {
    this.loadingElement = document.getElementById('loading');
    this.resultElement = document.getElementById('result');
    this.queryInput = document.getElementById('queryInput') as HTMLInputElement;
    this.submitButton = document.getElementById('submitButton') as HTMLButtonElement;
  }

  showLoading(message = 'جاري المعالجة...'): void {
    if (this.loadingElement) {
      this.loadingElement.style.display = 'block';
      this.loadingElement.textContent = message;
    }
    if (this.resultElement) {
      this.resultElement.style.display = 'none';
    }
    if (this.submitButton) {
      this.submitButton.disabled = true;
    }
  }

  hideLoading(): void {
    if (this.loadingElement) {
      this.loadingElement.style.display = 'none';
    }
    if (this.submitButton) {
      this.submitButton.disabled = false;
    }
  }

  showResult(result: any): void {
    if (!this.resultElement) return;

    this.resultElement.style.display = 'block';
    
    if (result.success) {
      this.resultElement.textContent = `
        <div class="success-result">
          <h3>✅ نجح الاستعلام</h3>
          <div class="response">${result.response || result.message}</div>
          ${result.data ? `<pre class="data">${JSON.stringify(result.data, null, 2)}</pre>` : ''}
        </div>
      `; /* XSS protection: innerHTML replaced */
    } else {
      this.resultElement.textContent = `
        <div class="error-result">
          <h3>❌ خطأ في الاستعلام</h3>
          <div class="error">${result.error || result.message}</div>
        </div>
      `; /* XSS protection: innerHTML replaced */
    }
  }

  processQuery(): void {
    const query = this.queryInput?.value?.trim();
    if (!query) {
      this.showResult({
        success: false,
        error: 'يرجى إدخال استعلام'
      });
      return;
    }

    this.showLoading('جاري معالجة الاستعلام...');

    if (typeof google !== 'undefined' && google.script?.run) {
      google.script.run
        .withSuccessHandler((result: any) => {
          this.hideLoading();
          this.showResult(result);
        })
        .withFailureHandler((error: Error) => {
          this.hideLoading();
          this.showResult({
            success: false,
            error: `خطأ في الاتصال: ${error.message}`
          });
        })
        .processQuery(query, 'sheets');
    } else {
      // Test mode
      setTimeout(() => {
        this.hideLoading();
        this.showResult({
          success: true,
          response: `تم معالجة الاستعلام: "${query}" بنجاح في الوضع التجريبي`,
          data: { timestamp: new Date().toISOString(), query }
        });
      }, 1500);
    }
  }

  analyzeSheet(): void {
    this.showLoading('جاري تحليل البيانات...');

    if (typeof google !== 'undefined' && google.script?.run) {
      google.script.run
        .withSuccessHandler((result: any) => {
          this.hideLoading();
          this.showResult(result);
        })
        .withFailureHandler((error: Error) => {
          this.hideLoading();
          this.showResult({
            success: false,
            error: `خطأ في التحليل: ${error.message}`
          });
        })
        .analyzeCurrentSheet();
    } else {
      // Test mode
      setTimeout(() => {
        this.hideLoading();
        this.showResult({
          success: true,
          response: 'تم تحليل البيانات بنجاح',
          data: {
            rows: 150,
            columns: 8,
            numericColumns: 5,
            analysis: 'البيانات تبدو صحيحة ومنظمة'
          }
        });
      }, 2000);
    }
  }
}