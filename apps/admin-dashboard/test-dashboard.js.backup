#!/usr/bin/env node

/**
 * ğŸ§ª AzizSys Admin Dashboard - Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø´Ø§Ù…Ù„Ø©
 * 
 * Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù ÙŠØ®ØªØ¨Ø± Ø¬Ù…ÙŠØ¹ ÙˆØ¸Ø§Ø¦Ù Dashboard Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ù…Ù„Ù‡Ø§
 * 
 * Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…: node test-dashboard.js
 */

const fs = require('fs');
const path = require('path');
const http = require('http');
const https = require('https');

// Ø£Ù„ÙˆØ§Ù† Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
const colors = {
    green: '\x1b[32m',
    red: '\x1b[31m',
    yellow: '\x1b[33m',
    blue: '\x1b[34m',
    reset: '\x1b[0m',
    bold: '\x1b[1m'
};

// Ø¯Ø§Ù„Ø© Ø·Ø¨Ø§Ø¹Ø© Ù…Ù„ÙˆÙ†Ø©
function log(message, color = 'reset') {
    // Removed console.log
}

// Ø¯Ø§Ù„Ø© ÙØ­Øµ HTTP
function checkHTTP(url, timeout = 5000) {
    return new Promise((resolve) => {
        const protocol = url.startsWith('https') ? https : http;
        const req = protocol.get(url, (res) => {
            resolve({
                success: true,
                status: res.statusCode,
                message: `HTTP ${res.statusCode}`
            });
        });
        
        req.on('error', (error) => {
            resolve({
                success: false,
                status: 0,
                message: error.message
            });
        });
        
        req.setTimeout(timeout, () => {
            req.destroy();
            resolve({
                success: false,
                status: 0,
                message: 'Timeout'
            });
        });
    });
}

// Ø¯Ø§Ù„Ø© ÙØ­Øµ ÙˆØ¬ÙˆØ¯ Ù…Ù„Ù
function checkFile(filePath) {
    try {
        const stats = /* PERFORMANCE: Consider using async version */ /* PERFORMANCE: Consider using async version */ fs.statSync(filePath);
        return {
            exists: true,
            size: stats.size,
            modified: stats.mtime
        };
    } catch (error) {
        return {
            exists: false,
            error: error.message
        };
    }
}

// Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù„ÙØ§Øª
async function testFiles() {
    log('\nğŸ“ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©...', 'blue');
    
    const files = [
        {
            name: 'Dashboard Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ',
            path: './AzizSys Developer Dashboard.html'
        },
        {
            name: 'API Bridge',
            path: './src/integration/api-bridge.js'
        },
        {
            name: 'Ù…Ù„Ù Ø§Ù„ØªØµÙ…ÙŠÙ…',
            path: './src/styles/dashboard.css'
        },
        {
            name: 'Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©',
            path: '../docs/6_fixing/reports/central_dashboard.json'
        }
    ];
    
    let passed = 0;
    
    for (const file of files) {
        const result = checkFile(file.path);
        if (result.exists) {
            log(`  âœ… ${file.name}: Ù…ÙˆØ¬ÙˆØ¯ (${Math.round(result.size/1024)}KB)`, 'green');
            passed++;
        } else {
            log(`  âŒ ${file.name}: Ù…ÙÙ‚ÙˆØ¯ - ${result.error}`, 'red');
        }
    }
    
    log(`\nğŸ“Š Ù†ØªÙŠØ¬Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ù„ÙØ§Øª: ${passed}/${files.length}`, passed === files.length ? 'green' : 'yellow');
    return passed === files.length;
}

// Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø®Ø¯Ù…Ø§Øª
async function testServices() {
    log('\nğŸŒ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø®Ø¯Ù…Ø§Øª...', 'blue');
    
    const services = [
        {
            name: 'Web Chatbot',
            url: 'http://localhost:3000',
            port: 3000
        },
        {
            name: 'API Server',
            url: 'http://localhost:3333',
            port: 3333
        },
        {
            name: 'Gemini Backend',
            url: 'http://localhost:8000',
            port: 8000
        }
    ];
    
    let passed = 0;
    
    for (const service of services) {
        const result = await checkHTTP(service.url + '/health');
        if (result.success) {
            log(`  âœ… ${service.name}: Ù…ØªØ§Ø­ (${result.message})`, 'green');
            passed++;
        } else {
            log(`  âŒ ${service.name}: ØºÙŠØ± Ù…ØªØ§Ø­ - ${result.message}`, 'red');
        }
    }
    
    log(`\nğŸ“Š Ù†ØªÙŠØ¬Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø®Ø¯Ù…Ø§Øª: ${passed}/${services.length}`, passed > 0 ? 'green' : 'red');
    return passed;
}

// Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø­ØªÙˆÙ‰ Dashboard
async function testDashboardContent() {
    log('\nğŸ¨ Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø­ØªÙˆÙ‰ Dashboard...', 'blue');
    
    const dashboardPath = './AzizSys Developer Dashboard.html';
    
    if (!/* PERFORMANCE: Consider using async version */ /* PERFORMANCE: Consider using async version */ fs.existsSync(dashboardPath)) {
        log('  âŒ Ù…Ù„Ù Dashboard ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'red');
        return false;
    }
    
    const content = /* PERFORMANCE: Consider using async version */ /* PERFORMANCE: Consider using async version */ fs.readFileSync(dashboardPath, 'utf8');
    
    const tests = [
        {
            name: 'Ø¹Ù†ÙˆØ§Ù† Dashboard',
            test: content.includes('AzizSys Developer Dashboard')
        },
        {
            name: 'Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠØ©',
            test: content.includes('showTab(') && content.includes('tab-content')
        },
        {
            name: 'Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©',
            test: content.includes('menu-item') && content.includes('onclick')
        },
        {
            name: 'Gemini AI',
            test: content.includes('Gemini Code Assistant') && content.includes('ai-messages')
        },
        {
            name: 'ÙˆÙƒÙŠÙ„ Ø§Ù„Ø±Ù‚ÙŠØ¨',
            test: content.includes('runComplianceAudit') && content.includes('compliance-agent-status')
        },
        {
            name: 'Ø§Ù„Ø³Ø¬Ù„Ø§Øª',
            test: content.includes('log-container') && content.includes('addLogEntry')
        },
        {
            name: 'API Bridge',
            test: content.includes('api-bridge.js') && content.includes('APIBridge')
        },
        {
            name: 'Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ',
            test: content.includes('setInterval') && content.includes('updateSystemMetrics')
        }
    ];
    
    let passed = 0;
    
    for (const test of tests) {
        if (test.test) {
            log(`  âœ… ${test.name}: Ù…ÙˆØ¬ÙˆØ¯`, 'green');
            passed++;
        } else {
            log(`  âŒ ${test.name}: Ù…ÙÙ‚ÙˆØ¯`, 'red');
        }
    }
    
    log(`\nğŸ“Š Ù†ØªÙŠØ¬Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰: ${passed}/${tests.length}`, passed === tests.length ? 'green' : 'yellow');
    return passed === tests.length;
}

// Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¯ÙˆØ§Ù„ JavaScript
async function testJavaScriptFunctions() {
    log('\nâš™ï¸ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¯ÙˆØ§Ù„ JavaScript...', 'blue');
    
    const dashboardPath = './AzizSys Developer Dashboard.html';
    
    if (!/* PERFORMANCE: Consider using async version */ /* PERFORMANCE: Consider using async version */ fs.existsSync(dashboardPath)) {
        log('  âŒ Ù…Ù„Ù Dashboard ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'red');
        return false;
    }
    
    const content = /* PERFORMANCE: Consider using async version */ /* PERFORMANCE: Consider using async version */ fs.readFileSync(dashboardPath, 'utf8');
    
    const functions = [
        'showTab',
        'askAI',
        'sendAIMessage',
        'getAIResponse',
        'runComplianceAudit',
        'quickComplianceCheck',
        'restartServices',
        'runTests',
        'deploySystem',
        'clearLogs',
        'checkHealth',
        'updateSystemMetrics',
        'addLogEntry',
        'refreshComplianceData'
    ];
    
    let passed = 0;
    
    for (const func of functions) {
        const regex = new RegExp(`function\\s+${func}\\s*\\(`, 'g');
        if (regex.test(content)) {
            log(`  âœ… ${func}(): Ù…ÙˆØ¬ÙˆØ¯Ø©`, 'green');
            passed++;
        } else {
            log(`  âŒ ${func}(): Ù…ÙÙ‚ÙˆØ¯Ø©`, 'red');
        }
    }
    
    log(`\nğŸ“Š Ù†ØªÙŠØ¬Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¯ÙˆØ§Ù„: ${passed}/${functions.length}`, passed === functions.length ? 'green' : 'yellow');
    return passed === functions.length;
}

// Ø§Ø®ØªØ¨Ø§Ø± Ù…Ù„Ù Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
async function testReportsFile() {
    log('\nğŸ“Š Ø§Ø®ØªØ¨Ø§Ø± Ù…Ù„Ù Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±...', 'blue');
    
    const reportsPath = '../docs/6_fixing/reports/central_dashboard.json';
    
    if (!/* PERFORMANCE: Consider using async version */ /* PERFORMANCE: Consider using async version */ fs.existsSync(reportsPath)) {
        log('  âŒ Ù…Ù„Ù Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'red');
        return false;
    }
    
    try {
        const content = /* PERFORMANCE: Consider using async version */ /* PERFORMANCE: Consider using async version */ fs.readFileSync(reportsPath, 'utf8');
        const data = JSON.parse(content);
        
        const tests = [
            {
                name: 'overall_progress',
                test: data.overall_progress && typeof data.overall_progress.percentage === 'number'
            },
            {
                name: 'compliance_agent',
                test: data.compliance_agent && typeof data.compliance_agent.compliance_score === 'number'
            },
            {
                name: 'services',
                test: data.services && typeof data.services === 'object'
            },
            {
                name: 'timestamp',
                test: data.timestamp && typeof data.timestamp === 'string'
            }
        ];
        
        let passed = 0;
        
        for (const test of tests) {
            if (test.test) {
                log(`  âœ… ${test.name}: ØµØ­ÙŠØ­`, 'green');
                passed++;
            } else {
                log(`  âŒ ${test.name}: Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ù†ÙŠØ©`, 'red');
            }
        }
        
        log(`\nğŸ“Š Ù†ØªÙŠØ¬Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±: ${passed}/${tests.length}`, passed === tests.length ? 'green' : 'yellow');
        return passed === tests.length;
        
    } catch (error) {
        log(`  âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© JSON: ${error.message}`, 'red');
        return false;
    }
}

// Ø§Ø®ØªØ¨Ø§Ø± Scripts
async function testScripts() {
    log('\nğŸ“œ Ø§Ø®ØªØ¨Ø§Ø± Scripts...', 'blue');
    
    const scripts = [
        'SIMPLE_START.bat',
        'OPEN_DASHBOARDS.bat',
        'LAUNCH_REAL_DASHBOARD.bat',
        'QUICK_START.bat'
    ];
    
    let passed = 0;
    
    for (const script of scripts) {
        const result = checkFile(script);
        if (result.exists) {
            log(`  âœ… ${script}: Ù…ÙˆØ¬ÙˆØ¯`, 'green');
            passed++;
        } else {
            log(`  âŒ ${script}: Ù…ÙÙ‚ÙˆØ¯`, 'red');
        }
    }
    
    log(`\nğŸ“Š Ù†ØªÙŠØ¬Ø© Ø§Ø®ØªØ¨Ø§Ø± Scripts: ${passed}/${scripts.length}`, passed === scripts.length ? 'green' : 'yellow');
    return passed === scripts.length;
}

// Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø£Ø¯Ø§Ø¡
async function testPerformance() {
    log('\nâš¡ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø£Ø¯Ø§Ø¡...', 'blue');
    
    const dashboardPath = './AzizSys Developer Dashboard.html';
    
    if (!/* PERFORMANCE: Consider using async version */ /* PERFORMANCE: Consider using async version */ fs.existsSync(dashboardPath)) {
        log('  âŒ Ù…Ù„Ù Dashboard ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'red');
        return false;
    }
    
    const stats = /* PERFORMANCE: Consider using async version */ /* PERFORMANCE: Consider using async version */ fs.statSync(dashboardPath);
    const sizeKB = Math.round(stats.size / 1024);
    
    const tests = [
        {
            name: 'Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù',
            test: sizeKB < 500,
            value: `${sizeKB}KB`,
            limit: '< 500KB'
        }
    ];
    
    let passed = 0;
    
    for (const test of tests) {
        if (test.test) {
            log(`  âœ… ${test.name}: ${test.value} ${test.limit}`, 'green');
            passed++;
        } else {
            log(`  âŒ ${test.name}: ${test.value} ÙŠØªØ¬Ø§ÙˆØ² ${test.limit}`, 'red');
        }
    }
    
    log(`\nğŸ“Š Ù†ØªÙŠØ¬Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø£Ø¯Ø§Ø¡: ${passed}/${tests.length}`, passed === tests.length ? 'green' : 'yellow');
    return passed === tests.length;
}

// Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
async function runAllTests() {
    log('ğŸ§ª Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª AzizSys Admin Dashboard', 'bold');
    log('=' .repeat(50), 'blue');
    
    const startTime = Date.now();
    
    const results = {
        files: await testFiles(),
        services: await testServices(),
        content: await testDashboardContent(),
        functions: await testJavaScriptFunctions(),
        reports: await testReportsFile(),
        scripts: await testScripts(),
        performance: await testPerformance()
    };
    
    const endTime = Date.now();
    const duration = Math.round((endTime - startTime) / 1000);
    
    // Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
    log('\n' + '=' .repeat(50), 'blue');
    log('ğŸ“‹ Ù…Ù„Ø®Øµ Ø§Ù„Ù†ØªØ§Ø¦Ø¬:', 'bold');
    
    let totalPassed = 0;
    let totalTests = 0;
    
    for (const [testName, result] of Object.entries(results)) {
        const status = result ? 'âœ…' : 'âŒ';
        const color = result ? 'green' : 'red';
        log(`  ${status} ${testName}: ${result ? 'Ù†Ø¬Ø­' : 'ÙØ´Ù„'}`, color);
        if (result) totalPassed++;
        totalTests++;
    }
    
    log('\nğŸ“Š Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©:', 'bold');
    log(`  Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù†Ø¬Ø­Øª: ${totalPassed}/${totalTests}`, totalPassed === totalTests ? 'green' : 'yellow');
    log(`  Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø³ØªØºØ±Ù‚: ${duration} Ø«Ø§Ù†ÙŠØ©`, 'blue');
    
    if (totalPassed === totalTests) {
        log('\nğŸ‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù†Ø¬Ø­Øª! Dashboard Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù….', 'green');
    } else {
        log('\nâš ï¸ Ø¨Ø¹Ø¶ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ÙØ´Ù„Øª. Ø±Ø§Ø¬Ø¹ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø£Ø¹Ù„Ø§Ù‡.', 'yellow');
    }
    
    log('\nğŸ’¡ Ù†ØµØ§Ø¦Ø­:', 'blue');
    log('  â€¢ Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª: npm run dev:api & npm run dev:web-chatbot');
    log('  â€¢ Ù„ÙØªØ­ Dashboard: SIMPLE_START.bat');
    log('  â€¢ Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©: Ø±Ø§Ø¬Ø¹ README.md');
    
    return totalPassed === totalTests;
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
if (require.main === module) {
    runAllTests().then(success => {
        process.exit(success ? 0 : 1);
    });
}

module.exports = {
    runAllTests,
    testFiles,
    testServices,
    testDashboardContent,
    testJavaScriptFunctions,
    testReportsFile,
    testScripts,
    testPerformance
};