# دليل المطور المتقدم - مشروع G-Assistant

**الإصدار:** 1.0
**الحالة:** إلزامي للمطورين الأساسيين

---

## 1.0 نظرة عامة

هذا الدليل مخصص للمطورين الذين فهموا الأساسيات الموضحة في `CONTRIBUTING.md` ويريدون الغوص في التفاصيل الفنية الدقيقة للمشروع. يغطي هذا الدليل الأنماط المتقدمة، والأدوات الداخلية، والممارسات التي تضمن استقرار وسلامة المشروع.

---

## 2.0 سير العمل الإلزامي عند تغيير هيكل المشروع

**تحذير:** تجاهل هذه القاعدة هو السبب الأكثر شيوعًا لأخطاء `TypeError: Cannot read properties of undefined`.

عندما تقوم بأي تغيير هيكلي، مثل **إضافة ملف جديد**، **حذف ملف**، أو **تغيير تبعيات وحدة ما** في `config/module_manifest.json`، يجب عليك **إعادة بناء ترتيب تحميل الملفات** قبل النشر.

1.  **إعادة بناء الترتيب:**

    ```bash
    node scripts/generatePushOrder.js
    ```

    هذا الأمر يقرأ `module_manifest.json` ويحدث `.clasp.json` بالترتيب الصحيح الذي يجب أن يتم به تحميل الملفات إلى Google Apps Script.

2.  **النشر:**
    ```bash
    clasp push
    ```

---

## 3.0 البرمجة الدفاعية: ضمان جاهزية الوحدات

بسبب التحميل غير المتزامن المحتمل للوحدات، لا تفترض أبدًا أن وحدة ما جاهزة للاستخدام. استخدم دائمًا `ModuleVerifier` للتحقق من جاهزيتها قبل استدعاء أي من دوالها.

- **النمط الصحيح:**

  ```javascript
  if (!ModuleVerifier.isReady('AI.Core')) {
    return Dialogue.createError(
      'الوحدة AI.Core غير جاهزة بعد، يرجى المحاولة مرة أخرى.'
    );
  }
  // الآن يمكنك استدعاء الوحدة بأمان
  const aiCore = Injector.get('AI.Core');
  aiCore.someFunction();
  ```

- \*\*النمط الخاطئ (يسبب أخطاء متقطعة):
  ```javascript
  // لا تفعل هذا!
  const aiCore = Injector.get('AI.Core');
  aiCore.someFunction(); // قد يفشل إذا لم تكن الوحدة جاهزة
  ```

---

## 4.0 أدوات التشخيص الداخلية

يحتوي المشروع على مجموعة من الدوال المساعدة لتشخيص حالته. يمكنك استدعاؤها من داخل محرر Google Apps Script:

| الدالة                     | الوصف                                                                 |
| -------------------------- | --------------------------------------------------------------------- |
| `reportModulesStatus()`    | تطبع تقريرًا في السجلات عن حالة تحميل كل وحدة مسجلة.                  |
| `runDocumentationAudit()`  | تبحث عن الوحدات أو الدوال العامة التي ليس لها توثيق في `DocsManager`. |
| `ModuleVerifier.scanAll()` | تقوم بفحص شامل لجاهزية جميع الوحدات وتُرجع تقريرًا.                   |
| `Injector.getAll()`        | تُرجع مصفوفة بأسماء جميع الوحدات التي تم حقنها بنجاح.                 |

---

## 5.0 إعادة هيكلة وتسمية الملفات بأمان

يعتمد نظامنا على **التبعيات المحددة في `module_manifest.json`** وليس على أسماء الملفات. هذا يمنحك حرية إعادة تنظيم الملفات، ولكن يجب اتباع الخطوات التالية بدقة:

لنفترض أنك تريد إعادة تسمية `30_tools/developer_tool.js` إلى `30_tools/code_reviewer.js`.

1.  **إعادة تسمية الملف:** قم بإعادة تسمية الملف في نظام الملفات المحلي.
2.  **تحديث المانيفست (الأهم):** اذهب إلى `config/module_manifest.json`، ابحث عن الوحدة ذات الصلة، وقم بتحديث مسار `file` الخاص بها إلى المسار الجديد.
3.  **إعادة بناء الترتيب (إلزامي):**
    ```bash
    node scripts/generatePushOrder.js
    ```
4.  **النشر:**
    ```bash
    clasp push
    ```

**توصية هامة:** بينما يمكنك إعادة تسمية معظم الملفات، **يوصى بشدة بالحفاظ على الترقيم (`00_`, `01_`) للملفات الأساسية** مثل `00_utils.js` و `00_initializer.js` لضمان تحميلها بالترتيب الصحيح دائمًا.
