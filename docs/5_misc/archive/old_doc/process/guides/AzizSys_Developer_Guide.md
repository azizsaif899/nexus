# 📖 AzizSys - دليل المطورين المحترف

مرحبًا بك في مشروع **AzizSys**!  
هذا النظام مصمم ليكون منصة هندسية قابلة للتوسعة، تعمل بذكاء عبر نظام وحدات مستقلة، حقن تبعيات، وتحليل ذاتي للأخطاء.  
هذا الدليل يساعدك على التطوير بأمان، وتوسعة النظام دون التسبب بانهيار معماري.

---

## 🚀 سير عمل النشر (Deployment Workflow)

لضمان استقرار النظام، يجب اتباع سير العمل هذا **دائمًا** عند نشر أي تغييرات.

1.  **مرحلة البناء (Build):** بعد أي تعديل على بنية المشروع (إضافة/حذف ملف، أو تغيير تبعيات في `module_manifest.json`)، يجب تشغيل هذا الأمر أولاً:
    ```bash
    node scripts/generatePushOrder.js
    ```
    هذا الأمر يضمن تحديث خطة التحميل (`filePushOrder`) لتكون صحيحة.

2.  **مرحلة النشر (Deploy):** بعد مرحلة البناء، يمكنك الآن دفع التغييرات بأمان إلى خوادم Google:
    ```bash
    clasp push
    ```

**تحذير:** تشغيل `clasp push` مباشرة دون تشغيل سكربت البناء أولاً بعد أي تغيير هيكلي سيعيد أخطاء التحميل والتبعيات.

---

## 🧱 1. إضافة وحدة (Module) جديدة

### الخطوات الأساسية:

1. **إنشاء ملف جديد:**
   - داخل مسار مثل `30_tools/new_tool.js`

2. **تعريف الوحدة باستخدام `defineModule`:**
```javascript
defineModule('System.Tools.NewTool', ({ Utils, Config }) => {
  return {
    summarizeData() {
      // your logic
    }
  };
});
```

3. **تسجيل الوحدة في `module_manifest.json`:**
```json
{
  "module": "System.Tools.NewTool",
  "file": "30_tools/new_tool.js",
  "dependencies": ["System.Utils", "System.Config"]
}
```

4. **تحديث ترتيب التحميل تلقائيًا:**
```bash
node scripts/generatePushOrder.js
```

5. **توثيق الوحدة في `DocsManager`:**
```javascript
DocsManager.registerModuleDocs('System.Tools.NewTool', {
  summary: 'أداة تحليل وتلخيص البيانات.',
  functions: {
    summarizeData: 'تلخيص جدول البيانات وتحويله إلى نقاط مختصرة.'
  }
});
```

---

## 🛡️ 2. البرمجة الدفاعية وحماية التبعيات

### أفضل الممارسات:

- **استخدام ModuleVerifier قبل أي استدعاء حساس:**
```javascript
if (!ModuleVerifier.isReady('AI.Core')) {
  return Dialogue.createError('الوحدة AI.Core غير جاهزة.');
}
```

- **استخدام fallback عند الاستدعاء غير الموثوق:**
```javascript
const agent = Injector.get('AgentsCatalog')?.handleRequest ?? (() => {
  return Dialogue.createError('الوكيل غير متاح حالياً.');
});
```

- **تمييز الأخطاء:**  
  - خطأ حرج (يجب إيقاف النظام): وحدة غير مسجلة في Injector  
  - خطأ مؤقت (يمكن تجاوزه): دالة غير متاحة مؤقتًا أو تأخير تحميل

---

## 🔍 3. أدوات الفحص والتشخيص

| الأداة | الوصف |
|-------|--------|
| `reportModulesStatus()` | يعرض حالة الوحدات الأساسية في السجلات |
| `runDocumentationAudit()` | يكشف عن الوحدات أو الدوال غير الموثقة |
| `ModuleVerifier.scanAll()` | يفحص جاهزية كل وحدة مسجلة |
| `DependencyGuardian.waitFor(...)` | يتحقق من تحميل وحدة خلال وقت معين |
| `Logger.log(Object.keys(Injector.getAll()))` | يعرض جميع الوحدات المسجلة فعليًا |

### 3.1 المراقبة الحية للأخطاء (Live Error Monitoring)

للحصول على تشخيص فوري للأخطاء دون الحاجة لفتح سجلات Apps Script يدويًا، يمكنك إعداد نظام مراقبة حي باستخدام `nodemon`.

**المتطلبات:**
-   تثبيت `Node.js` على جهازك.
-   تثبيت `nodemon` عالميًا: `npm install -g nodemon`

**خطوات الإعداد والتشغيل:**

1.  **تصدير سجل الأخطاء:** من محرر Apps Script، قم بتشغيل دالة `createLiveErrorFile()` مرة واحدة على الأقل.
2.  **تنزيل الملف:** اذهب إلى Google Drive، ستجد ملفًا باسم `AzizSys_ErrorLog.js`. قم بتنزيله وضعه في المجلد الرئيسي لمشروعك.
3.  **بدء المراقبة:** في سطر الأوامر (Terminal) من المجلد الرئيسي لمشروعك، قم بتشغيل:
    ```bash
    nodemon
    ```
4.  **النتيجة:** ستقوم شاشة سطر الأوامر الآن بعرض الأخطاء المسجلة. في كل مرة تقوم فيها بتحديث ملف `AzizSys_ErrorLog.js` (عبر تشغيل `createLiveErrorFile()` مرة أخرى وتنزيل الملف المحدث)، سيقوم `nodemon` بتحديث الشاشة تلقائيًا بأحدث سجل.

---

## 📦 4. التوثيق والصيانة

- كل وحدة يجب أن تُسجل في `DocsManager.registerModuleDocs(...)`
- لا يُسمح بوجود دوال عامة غير موثقة
- ملف `module_docs.json` يُولد تلقائيًا من `DocsManager`

---

## 📘 5. التوصيات المعمارية الإضافية

- استخدم التسميات الموحدة: `System.Domain.Functionality`
- الوحدات الأساسية يجب أن تبدأ بـ `00_`, `01_`, لضمان ترتيب التحميل
- الوكلاء (Agents) يجب أن تُحمّل قبل الكتالوج
- الواجهة (UI) تُحمّل بعد جميع الوحدات الأخرى
- فك الدورات عبر تقسيم الكود إلى وحدة مشتركة مستقلة

---

## 🧠 ماذا تفعل عند ظهور خطأ مثل:
```text
TypeError: Cannot read properties of undefined (reading 'handleRequest')
```

- تحقق من ترتيب التحميل في `.clasp.json`
- راجع أن الوحدة مسجلة في `Injector.dependencyMap`
- تأكد من أن `ModuleVerifier.isReady()` تم استخدامه قبل الاستدعاء
- تأكد من اكتمال التسجيل داخل `defineModule`

---

## 🔄 6. إعادة تسمية وإعادة هيكلة الوحدات

النظام الآن ذكي بما يكفي ليعتمد على **التبعيات** وليس على **أسماء الملفات**. هذا يمنحك حرية كبيرة في تنظيم مشروعك.

### هل يمكنني تغيير أسماء الملفات؟

**نعم، يمكنك ذلك لمعظم الملفات.** السكربت `generatePushOrder.js` لا يهتم باسم الملف، بل يهتم فقط بمسار الملف (`file`) المحدد لكل وحدة في `module_manifest.json`.

### سير العمل الآمن لإعادة تسمية ملف:

لنفترض أنك تريد إعادة تسمية `30_tools/4_tools_developer.js` إلى `tools/developer.js`.

1.  **[ ] إعادة تسمية الملف:** قم بإعادة تسمية الملف في نظام الملفات المحلي لديك.
2.  **[ ] تحديث المانيفست (خطوة حاسمة):** اذهب إلى `module_manifest.json` وابحث عن وحدة `System.ToolsDeveloper` وقم بتحديث مسار `file` الخاص بها:
    ```json
    // before
    "file": "30_tools/4_tools_developer.js",
    // after
    "file": "tools/developer.js",
    ```
3.  **[ ] تشغيل سكربت البناء (خطوة إلزامية):**
    ```bash
    node scripts/generatePushOrder.js
    ```
    سيقوم السكربت بقراءة المسار الجديد وتحديث `.clasp.json` تلقائيًا.
4.  **[ ] نشر التغييرات:**
    ```bash
    clasp push
    ```
    سيقوم `clasp` بحذف الملف القديم من الخادم وإنشاء الملف الجديد.

### ⚠️ توصية هامة:

بينما يمكنك إعادة تسمية معظم الملفات، **يوصى بشدة بالحفاظ على الترقيم (`00_`, `01_`) للملفات الأساسية للإقلاع** (مثل `00_utils.js`, `00_module_verifier.js`) والملف النهائي (`00_initializer.js`). هذا الترقيم يوفر ضمانًا بصريًا وإضافيًا بأن هذه الملفات الحساسة جدًا يتم تحميلها بالترتيب الصحيح دائمًا.

---

## 🔄 6. إعادة تسمية وإعادة هيكلة الوحدات

النظام الآن ذكي بما يكفي ليعتمد على **التبعيات** وليس على **أسماء الملفات**. هذا يمنحك حرية كبيرة في تنظيم مشروعك.

### هل يمكنني تغيير أسماء الملفات؟

**نعم، يمكنك ذلك لمعظم الملفات.** السكربت `generatePushOrder.js` لا يهتم باسم الملف، بل يهتم فقط بمسار الملف (`file`) المحدد لكل وحدة في `module_manifest.json`.

### سير العمل الآمن لإعادة تسمية ملف:

لنفترض أنك تريد إعادة تسمية `30_tools/4_tools_developer.js` إلى `tools/developer.js`.

1.  **[ ] إعادة تسمية الملف:** قم بإعادة تسمية الملف في نظام الملفات المحلي لديك.
2.  **[ ] تحديث المانيفست (خطوة حاسمة):** اذهب إلى `module_manifest.json` وابحث عن وحدة `System.ToolsDeveloper` وقم بتحديث مسار `file` الخاص بها:
    ```json
    // before
    "file": "30_tools/4_tools_developer.js",
    // after
    "file": "tools/developer.js",
    ```
3.  **[ ] تشغيل سكربت البناء (خطوة إلزامية):**
    ```bash
    node scripts/generatePushOrder.js
    ```
    سيقوم السكربت بقراءة المسار الجديد وتحديث `.clasp.json` تلقائيًا.
4.  **[ ] نشر التغييرات:**
    ```bash
    clasp push
    ```
    سيقوم `clasp` بحذف الملف القديم من الخادم وإنشاء الملف الجديد.

### ⚠️ توصية هامة:

بينما يمكنك إعادة تسمية معظم الملفات، **يوصى بشدة بالحفاظ على الترقيم (`00_`, `01_`) للملفات الأساسية للإقلاع** (مثل `00_utils.js`, `00_module_verifier.js`) والملف النهائي (`00_initializer.js`). هذا الترقيم يوفر ضمانًا بصريًا وإضافيًا بأن هذه الملفات الحساسة جدًا يتم تحميلها بالترتيب الصحيح دائمًا.

---

## 🔄 6. إعادة تسمية وإعادة هيكلة الوحدات

النظام الآن ذكي بما يكفي ليعتمد على **التبعيات** وليس على **أسماء الملفات**. هذا يمنحك حرية كبيرة في تنظيم مشروعك.

### هل يمكنني تغيير أسماء الملفات؟

**نعم، يمكنك ذلك لمعظم الملفات.** السكربت `generatePushOrder.js` لا يهتم باسم الملف، بل يهتم فقط بمسار الملف (`file`) المحدد لكل وحدة في `module_manifest.json`.

### سير العمل الآمن لإعادة تسمية ملف:

لنفترض أنك تريد إعادة تسمية `30_tools/4_tools_developer.js` إلى `tools/developer.js`.

1.  **[ ] إعادة تسمية الملف:** قم بإعادة تسمية الملف في نظام الملفات المحلي لديك.
2.  **[ ] تحديث المانيفست (خطوة حاسمة):** اذهب إلى `module_manifest.json` وابحث عن وحدة `System.ToolsDeveloper` وقم بتحديث مسار `file` الخاص بها:
    ```json
    // before
    "file": "30_tools/4_tools_developer.js",
    // after
    "file": "tools/developer.js",
    ```
3.  **[ ] تشغيل سكربت البناء (خطوة إلزامية):**
    ```bash
    node scripts/generatePushOrder.js
    ```
    سيقوم السكربت بقراءة المسار الجديد وتحديث `.clasp.json` تلقائيًا.
4.  **[ ] نشر التغييرات:**
    ```bash
    clasp push
    ```
    سيقوم `clasp` بحذف الملف القديم من الخادم وإنشاء الملف الجديد.

### ⚠️ توصية هامة:

بينما يمكنك إعادة تسمية معظم الملفات، **يوصى بشدة بالحفاظ على الترقيم (`00_`, `01_`) للملفات الأساسية للإقلاع** (مثل `00_utils.js`, `00_module_verifier.js`) والملف النهائي (`00_initializer.js`). هذا الترقيم يوفر ضمانًا بصريًا وإضافيًا بأن هذه الملفات الحساسة جدًا يتم تحميلها بالترتيب الصحيح دائمًا.

# 🚀 المميزات الجديدة التي أضفناها اليوم

- نظام مراجعة ذاتي باستخدام `reviewProjectHealth.js` و `fixProjectStructure.js`.
- توليد تقرير `final_review.md` يحتوي على تبعيات مفقودة ووحدات غير مسجلة.
- دمج الوحدات المكررة في وحدات موحدة أكثر وضوحًا.
- تحسين أمان النظام عبر تحذيرات في `Security.encrypt` وفلترة المسارات في `exportCurrentProjectSource`.
- تفعيل القياس عن بعد في عمليات التصدير باستخدام `Telemetry.track`.
- إضافة زر تصدير مباشر في واجهة المطورين `DeveloperSidebar.html`.
- دعم التحويل إلى JavaScript ES6 باستخدام `import/export` بدل `Injector.get`.
