# استراتيجية الاختبار (Testing Strategy) - مشروع G-Assistant

**الإصدار:** 1.0
**الحالة:** إلزامي

---

## 1.0 نظرة عامة

تهدف هذه الوثيقة إلى تحديد استراتيجية الاختبار الشاملة لمشروع `g-assistant`. الهدف هو ضمان جودة وموثوقية وأداء النظام من خلال نهج متعدد الطبقات، مع التركيز على الأتمتة حيثما أمكن في بيئة Google Apps Script.

---

## 2.0 هرم الاختبار (The Testing Pyramid)

نعتمد على نموذج هرم الاختبار لتركيز جهودنا حيث تكون أكثر فعالية.

### الطبقة الأولى: اختبارات الوحدة (Unit Tests) - الأساس
- **الهدف:** اختبار أصغر أجزاء الكود (الدوال الفردية) بمعزل تام عن بقية النظام.
- **التغطية:** يجب أن تغطي اختبارات الوحدة المنطق الحرج في مجلدات `20_ai`, `25_ai_agents`, `30_tools`, و `90_System`.
- **الأدوات:**
  - إطار العمل: `Jest`.
  - المحاكاة (Mocking): محاكاة خدمات Google Apps Script العامة (`UrlFetchApp`, `SpreadsheetApp`, `PropertiesService`) أمر بالغ الأهمية.
- **مثال على المحاكاة:**
  ```javascript
  // في ملف الاختبار: __tests__/my-test.test.js
  const mockSpreadsheet = { ... }; // كائن محاكاة للجدول
  global.SpreadsheetApp = {
    openById: jest.fn().mockReturnValue(mockSpreadsheet)
  };
  ```

### الطبقة الثانية: اختبارات التكامل (Integration Tests)
- **الهدف:** اختبار التفاعل بين مكونين أو أكثر للتأكد من أنهما يعملان معًا بشكل صحيح.
- **سيناريوهات:**
  - هل يقوم المنسق (`Orchestrator`) باستدعاء الوكيل (`Agent`) الصحيح؟
  - هل يستطيع الوكيل استدعاء الأداة (`Tool`) وتمرير البيانات إليها بشكل صحيح؟
  - هل يتم تسجيل الأخطاء في `Telemetry` عند فشل استدعاء API؟

### الطبقة الثالثة: اختبارات قبول المستخدم (UAT) / الاختبارات اليدوية
- **الهدف:** التحقق من أن النظام يلبي متطلبات المستخدم ويعمل بشكل صحيح في بيئة Google Workspace الحقيقية.
- **التنفيذ:** يتم تنفيذ هذه الاختبارات يدويًا من خلال الواجهة الجانبية (Sidebar) في Google Sheets أو Docs، باتباع سيناريوهات استخدام محددة.

---

## 3.0 الأدوات والبيئة

- **إطار العمل الرئيسي:** `Jest`.
- **بيئة التشغيل:** يتم تشغيل جميع الاختبارات الآلية محليًا عبر `npm` قبل أي عملية دفع (push).
- **الأمر الرئيسي:** `npm test`.

---

## 4.0 أفضل الممارسات

1.  **أسماء وصفية:** يجب أن يصف اسم الاختبار ما يفعله بوضوح (e.g., `it('should return the correct sheet data when given a valid range')`).
2.  **نمط AAA:** يجب أن تتبع الاختبارات نمط **Arrange, Act, Assert** (ترتيب، تنفيذ، تأكيد).
3.  **اختبار واحد لكل حالة:** يجب أن يركز كل اختبار على تأكيد سلوك واحد فقط.
4.  **الاستقلالية:** يجب أن يكون كل اختبار مستقلاً تمامًا ولا يعتمد على نتائج اختبار آخر.
5.  **المحاكاة الشاملة:** أي اعتمادية على خدمات Google أو واجهات برمجة التطبيقات الخارجية يجب محاكاتها لتجنب الاعتماد على الشبكة وضمان سرعة الاختبارات.

---

## 5.0 التكامل المستمر (Continuous Integration)

- **الفحص الآلي:** في كل طلب سحب (Pull Request)، يجب أن يتم تشغيل الأوامر التالية تلقائيًا:
  - `npm run lint`: للتحقق من جودة الكود.
  - `npm run test`: لتشغيل جميع اختبارات الوحدة والتكامل.
- **شروط النجاح:** لن يتم قبول أي طلب سحب إلا بعد نجاح جميع الفحوصات الآلية.

---

## 6.0 أهداف تغطية الكود (Code Coverage Goals)

نسعى جاهدين لتحقيق أهداف التغطية التالية كدليل على جودة الاختبار:

- **الوحدات الحرجة (`20_ai`, `90_System`):** +85%
- **الأدوات والوكلاء (`30_tools`, `25_ai_agents`):** +75%
- **متوسط المشروع:** +80%
