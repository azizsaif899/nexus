#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ğŸ” DeepSeek AI Code Analyzer v3.0
Ù†Ø¸Ø§Ù… ÙØ­Øµ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…ØªÙ‚Ø¯Ù… Ù…Ø¹ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
"""

import os
import re
import json
import time
import hashlib
from datetime import datetime
from pathlib import Path
from typing import Dict, List, Any, Tuple
import logging

class DeepSeekAnalyzer:
    def __init__(self, project_root: str = None):
        self.project_root = project_root or os.getcwd()
        self.reports_dir = os.path.join(os.path.dirname(__file__), "reports")
        self.logs_dir = os.path.join(os.path.dirname(__file__), "logs")
        self.setup_directories()
        self.setup_logging()
        
        # Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„ÙØ­Øµ Ø§Ù„Ø£Ù…Ù†ÙŠ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©
        self.security_patterns = [
            # Ù…Ø®Ø§Ø·Ø± Ø­Ø±Ø¬Ø©
            (r'eval\s*\(', 'CRITICAL', 'Code Injection', 'Ø§Ø³ØªØ®Ø¯Ø§Ù… eval Ø®Ø·ÙŠØ± Ø£Ù…Ù†ÙŠØ§Ù‹'),
            (r'exec\s*\(', 'CRITICAL', 'Code Execution', 'Ø§Ø³ØªØ®Ø¯Ø§Ù… exec Ø®Ø·ÙŠØ± Ø£Ù…Ù†ÙŠØ§Ù‹'),
            (r'password\s*=\s*["\'][^"\']*["\']', 'CRITICAL', 'Hardcoded Password', 'ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù…ÙƒØ´ÙˆÙØ© ÙÙŠ Ø§Ù„ÙƒÙˆØ¯'),
            (r'api_key\s*=\s*["\'][^"\']*["\']', 'CRITICAL', 'Exposed API Key', 'Ù…ÙØªØ§Ø­ API Ù…ÙƒØ´ÙˆÙ'),
            (r'secret\s*=\s*["\'][^"\']*["\']', 'CRITICAL', 'Hardcoded Secret', 'Ø³Ø± Ù…ÙƒØ´ÙˆÙ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯'),
            
            # Ù…Ø®Ø§Ø·Ø± Ø¹Ø§Ù„ÙŠØ©
            (r'innerHTML\s*=.*\+', 'HIGH', 'XSS', 'innerHTML Ù…Ø¹ ØªØ³Ù„Ø³Ù„ Ù†ØµÙˆØµ Ù‚Ø¯ ÙŠØ¤Ø¯ÙŠ Ù„Ù€ XSS'),
            (r'document\.write\s*\(', 'HIGH', 'XSS', 'Ø§Ø³ØªØ®Ø¯Ø§Ù… document.write Ø®Ø·ÙŠØ±'),
            (r'dangerouslySetInnerHTML', 'HIGH', 'XSS', 'Ø§Ø³ØªØ®Ø¯Ø§Ù… dangerouslySetInnerHTML ÙÙŠ React'),
            (r'os\.system\s*\(', 'HIGH', 'Command Injection', 'Ø§Ø³ØªØ®Ø¯Ø§Ù… os.system Ø®Ø·ÙŠØ±'),
            (r'subprocess\.call\s*\(.*shell=True', 'HIGH', 'Command Injection', 'subprocess Ù…Ø¹ shell=True'),
            
            # Ù…Ø®Ø§Ø·Ø± Ù…ØªÙˆØ³Ø·Ø©
            (r'TODO|FIXME|HACK', 'MEDIUM', 'Code Quality', 'ØªØ¹Ù„ÙŠÙ‚Ø§Øª ØªØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø©'),
            (r'console\.error\s*\(', 'MEDIUM', 'Error Handling', 'Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø®Ø·Ø§Ø¡ ØºÙŠØ± Ù…Ù†Ø§Ø³Ø¨Ø©'),
            (r'catch\s*\(\s*\)\s*\{', 'MEDIUM', 'Empty Catch', 'catch ÙØ§Ø±Øº Ù‚Ø¯ ÙŠØ®ÙÙŠ Ø£Ø®Ø·Ø§Ø¡'),
            
            # Ù…Ø®Ø§Ø·Ø± Ù…Ù†Ø®ÙØ¶Ø©
            (r'console\.log\s*\(', 'LOW', 'Debug Code', 'console.log ÙÙŠ ÙƒÙˆØ¯ Ø§Ù„Ø¥Ù†ØªØ§Ø¬'),
            (r'debugger\s*;', 'LOW', 'Debug Code', 'debugger ÙÙŠ ÙƒÙˆØ¯ Ø§Ù„Ø¥Ù†ØªØ§Ø¬'),
            (r'alert\s*\(', 'LOW', 'User Experience', 'Ø§Ø³ØªØ®Ø¯Ø§Ù… alert Ù‚Ø¯ ÙŠØ¶Ø± Ø¨ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…'),
        ]
        
        # Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…Ø©
        self.supported_extensions = {
            '.js', '.jsx', '.ts', '.tsx', '.py', '.java', '.php', '.rb', '.go',
            '.cs', '.cpp', '.c', '.h', '.sql', '.html', '.css', '.scss', '.vue',
            '.json', '.xml', '.yaml', '.yml', '.md', '.sh', '.bat', '.ps1'
        }
        
        # Ù…Ø¬Ù„Ø¯Ø§Øª ÙŠØ¬Ø¨ ØªØ¬Ø§Ù‡Ù„Ù‡Ø§
        self.ignore_dirs = {
            'node_modules', '.git', '.nx', 'dist', 'build', '__pycache__',
            '.vscode', '.idea', 'coverage', '.nyc_output', 'logs', 'tmp'
        }

    def setup_directories(self):
        """Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©"""
        os.makedirs(self.reports_dir, exist_ok=True)
        os.makedirs(self.logs_dir, exist_ok=True)

    def setup_logging(self):
        """Ø¥Ø¹Ø¯Ø§Ø¯ Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ø¬Ù„Ø§Øª"""
        log_file = os.path.join(self.logs_dir, f"deepseek_{datetime.now().strftime('%Y%m%d_%H%M%S')}.log")
        logging.basicConfig(
            level=logging.INFO,
            format='%(asctime)s - %(levelname)s - %(message)s',
            handlers=[
                logging.FileHandler(log_file, encoding='utf-8'),
                logging.StreamHandler()
            ]
        )
        self.logger = logging.getLogger(__name__)

    def scan_file(self, file_path: str) -> List[Dict[str, Any]]:
        """ÙØ­Øµ Ù…Ù„Ù ÙˆØ§Ø­Ø¯"""
        issues = []
        try:
            with open(file_path, 'r', encoding='utf-8', errors='ignore') as f:
                content = f.read()
                lines = content.split('\n')
                
                for line_num, line in enumerate(lines, 1):
                    for pattern, severity, issue_type, description in self.security_patterns:
                        if re.search(pattern, line, re.IGNORECASE):
                            issues.append({
                                'file': file_path,
                                'line': line_num,
                                'severity': severity,
                                'type': issue_type,
                                'description': description,
                                'code': line.strip(),
                                'pattern': pattern
                            })
        except Exception as e:
            self.logger.error(f"Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„Ù…Ù„Ù {file_path}: {str(e)}")
        
        return issues

    def scan_directory(self, directory: str = None) -> Dict[str, Any]:
        """ÙØ­Øµ Ù…Ø¬Ù„Ø¯ ÙƒØ§Ù…Ù„"""
        if directory is None:
            directory = self.project_root
            
        self.logger.info(f"Ø¨Ø¯Ø¡ ÙØ­Øµ Ø§Ù„Ù…Ø¬Ù„Ø¯: {directory}")
        
        all_issues = []
        scanned_files = 0
        start_time = time.time()
        
        for root, dirs, files in os.walk(directory):
            # ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ø±ØºÙˆØ¨Ø©
            dirs[:] = [d for d in dirs if d not in self.ignore_dirs]
            
            for file in files:
                file_path = os.path.join(root, file)
                file_ext = Path(file).suffix.lower()
                
                if file_ext in self.supported_extensions:
                    issues = self.scan_file(file_path)
                    all_issues.extend(issues)
                    scanned_files += 1
                    
                    if scanned_files % 50 == 0:
                        self.logger.info(f"ØªÙ… ÙØ­Øµ {scanned_files} Ù…Ù„Ù...")
        
        scan_time = time.time() - start_time
        
        # ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        severity_counts = {'CRITICAL': 0, 'HIGH': 0, 'MEDIUM': 0, 'LOW': 0}
        for issue in all_issues:
            severity_counts[issue['severity']] += 1
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
        report = {
            'scan_info': {
                'timestamp': datetime.now().isoformat(),
                'directory': directory,
                'scanned_files': scanned_files,
                'scan_duration': round(scan_time, 2),
                'analyzer_version': '3.0'
            },
            'summary': {
                'total_issues': len(all_issues),
                'critical_issues': severity_counts['CRITICAL'],
                'high_issues': severity_counts['HIGH'],
                'medium_issues': severity_counts['MEDIUM'],
                'low_issues': severity_counts['LOW']
            },
            'issues': all_issues,
            'compliance': {
                'score': self.calculate_compliance_score(severity_counts, scanned_files),
                'standards': ['OWASP', 'CWE', 'SANS']
            }
        }
        
        self.logger.info(f"Ø§ÙƒØªÙ…Ù„ Ø§Ù„ÙØ­Øµ: {len(all_issues)} Ù…Ø´ÙƒÙ„Ø© ÙÙŠ {scanned_files} Ù…Ù„Ù")
        return report

    def calculate_compliance_score(self, severity_counts: Dict[str, int], total_files: int) -> int:
        """Ø­Ø³Ø§Ø¨ Ù†Ù‚Ø§Ø· Ø§Ù„Ø§Ù…ØªØ«Ø§Ù„ Ø§Ù„Ø£Ù…Ù†ÙŠ"""
        if total_files == 0:
            return 100
            
        # Ù†Ø¸Ø§Ù… Ù†Ù‚Ø§Ø·: ÙƒÙ„ Ù…Ø´ÙƒÙ„Ø© Ø­Ø±Ø¬Ø© = -10ØŒ Ø¹Ø§Ù„ÙŠØ© = -5ØŒ Ù…ØªÙˆØ³Ø·Ø© = -2ØŒ Ù…Ù†Ø®ÙØ¶Ø© = -1
        penalty = (
            severity_counts['CRITICAL'] * 10 +
            severity_counts['HIGH'] * 5 +
            severity_counts['MEDIUM'] * 2 +
            severity_counts['LOW'] * 1
        )
        
        # Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø· Ù…Ù† 100
        score = max(0, 100 - (penalty * 100 // (total_files * 5)))
        return min(100, score)

    def save_report(self, report: Dict[str, Any]) -> str:
        """Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ±"""
        timestamp = int(time.time() * 1000)
        report_file = os.path.join(self.reports_dir, f"scan_report_{timestamp}.json")
        
        with open(report_file, 'w', encoding='utf-8') as f:
            json.dump(report, f, ensure_ascii=False, indent=2)
        
        self.logger.info(f"ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ±: {report_file}")
        return report_file

    def generate_summary_report(self, report: Dict[str, Any]) -> str:
        """Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ù…Ù„Ø®Øµ"""
        summary = f"""
ØªÙ‚Ø±ÙŠØ± ÙØ­Øµ Ø§Ù„Ø£Ù…Ø§Ù† - DeepSeek AI Analyzer v3.0
{'='*60}

Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙØ­Øµ:
- Ø§Ù„ØªØ§Ø±ÙŠØ®: {report['scan_info']['timestamp']}
- Ø§Ù„Ù…Ø¬Ù„Ø¯: {report['scan_info']['directory']}
- Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ÙØ­ÙˆØµØ©: {report['scan_info']['scanned_files']}
- Ù…Ø¯Ø© Ø§Ù„ÙØ­Øµ: {report['scan_info']['scan_duration']} Ø«Ø§Ù†ÙŠØ©

Ù…Ù„Ø®Øµ Ø§Ù„Ù†ØªØ§Ø¦Ø¬:
- Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„: {report['summary']['total_issues']}
- Ù…Ø´Ø§ÙƒÙ„ Ø­Ø±Ø¬Ø©: {report['summary']['critical_issues']}
- Ù…Ø´Ø§ÙƒÙ„ Ø¹Ø§Ù„ÙŠØ©: {report['summary']['high_issues']}
- Ù…Ø´Ø§ÙƒÙ„ Ù…ØªÙˆØ³Ø·Ø©: {report['summary']['medium_issues']}
- Ù…Ø´Ø§ÙƒÙ„ Ù…Ù†Ø®ÙØ¶Ø©: {report['summary']['low_issues']}

Ù†Ù‚Ø§Ø· Ø§Ù„Ø§Ù…ØªØ«Ø§Ù„ Ø§Ù„Ø£Ù…Ù†ÙŠ: {report['compliance']['score']}/100

{'='*60}
"""
        
        if report['summary']['critical_issues'] > 0:
            summary += "\nØªØ­Ø°ÙŠØ±: ØªÙˆØ¬Ø¯ Ù…Ø´Ø§ÙƒÙ„ Ø£Ù…Ù†ÙŠØ© Ø­Ø±Ø¬Ø© ØªØ­ØªØ§Ø¬ Ø¥ØµÙ„Ø§Ø­ ÙÙˆØ±ÙŠ!\n"
        elif report['summary']['high_issues'] > 0:
            summary += "\nØªÙ†Ø¨ÙŠÙ‡: ØªÙˆØ¬Ø¯ Ù…Ø´Ø§ÙƒÙ„ Ø£Ù…Ù†ÙŠØ© Ø¹Ø§Ù„ÙŠØ© Ø§Ù„Ø®Ø·ÙˆØ±Ø©.\n"
        else:
            summary += "\nØ§Ù„ÙƒÙˆØ¯ ÙŠØ¨Ø¯Ùˆ Ø¢Ù…Ù†Ø§Ù‹ Ù†Ø³Ø¨ÙŠØ§Ù‹.\n"
        
        return summary

    def run_full_scan(self, directory: str = None) -> str:
        """ØªØ´ØºÙŠÙ„ ÙØ­Øµ ÙƒØ§Ù…Ù„"""
        print("Ø¨Ø¯Ø¡ ÙØ­Øµ DeepSeek AI...")
        
        report = self.scan_directory(directory)
        report_file = self.save_report(report)
        
        # Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ù„Ø®Øµ
        summary = self.generate_summary_report(report)
        print(summary)
        
        return report_file

def main():
    """Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"""
    import argparse
    
    parser = argparse.ArgumentParser(description='DeepSeek AI Code Analyzer')
    parser.add_argument('--dir', '-d', help='Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù„Ù„ÙØ­Øµ')
    parser.add_argument('--config', '-c', help='Ù…Ù„Ù Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª')
    
    args = parser.parse_args()
    
    # ØªØ­Ø¯ÙŠØ¯ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
    project_dir = args.dir or os.path.join(os.path.dirname(__file__), '..', '..', '..', '..')
    project_dir = os.path.abspath(project_dir)
    
    analyzer = DeepSeekAnalyzer(project_dir)
    report_file = analyzer.run_full_scan()
    
    print(f"\nØ§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙƒØ§Ù…Ù„ Ù…Ø­ÙÙˆØ¸ ÙÙŠ: {report_file}")
    print("Ø§ÙØªØ­ dashboard.html Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ")

if __name__ == "__main__":
    main()