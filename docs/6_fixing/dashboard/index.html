<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepSeek Analysis Report</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Arial, sans-serif; background: linear-gradient(135deg, #1d2b64 0%, #485563 100%); min-height: 100vh; color: #333; }
        .container { max-width: 1600px; margin: 0 auto; padding: 25px; }
        .header { background: rgba(255,255,255,0.98); color: #2c3e50; padding: 30px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 15px 30px rgba(0,0,0,0.1); }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; background: linear-gradient(135deg, #1d2b64, #485563); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: rgba(255,255,255,0.98); padding: 25px; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.08); text-align: center; transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .stat-card:hover { transform: translateY(-8px); box-shadow: 0 18px 35px rgba(0,0,0,0.12); }
        .stat-number { font-size: 2.2rem; font-weight: bold; margin-bottom: 8px; }
        .section { background: rgba(255,255,255,0.98); border-radius: 15px; padding: 30px; margin-bottom: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.08); }
        .section h2 { color: #2c3e50; margin-bottom: 20px; font-size: 1.6rem; border-bottom: 2px solid #ecf0f1; padding-bottom: 10px; }
        .severity-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px; }
        .severity-card { padding: 18px; border-radius: 10px; text-align: center; font-weight: bold; color: white; transition: transform 0.3s; }
        .severity-card:hover { transform: scale(1.05); }
        .sev-CRITICAL { background: linear-gradient(135deg, #c0392b, #e74c3c); }
        .sev-HIGH { background: linear-gradient(135deg, #d35400, #f39c12); }
        .sev-MEDIUM { background: linear-gradient(135deg, #f1c40f, #f39c12); }
        .sev-LOW { background: linear-gradient(135deg, #27ae60, #2ecc71); }
        .issues-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .issues-table th, .issues-table td { padding: 12px 15px; text-align: right; border-bottom: 1px solid #ecf0f1; }
        .issues-table th { background: linear-gradient(135deg, #2c3e50, #485563); color: white; }
        .issues-table tr:nth-child(even) { background: #f8f9fa; }
        .issues-table tr:hover { background: #e9ecef; }
        .file-path { font-family: 'Courier New', monospace; font-size: 0.9rem; color: #e74c3c; }
        .suggestion { background: #e8f5e9; color: #2e7d32; padding: 8px; border-radius: 6px; font-size: 0.9rem; margin-top: 8px; white-space: pre-wrap; }
        #summary-container { white-space: pre-wrap; font-family: 'Courier New', monospace; background: #2c3e50; color: #ecf0f1; padding: 20px; border-radius: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>DeepSeek Analysis Report</h1>
            <div id="report-timestamp"></div>
        </div>

        <div class="stats-grid" id="stats-grid">
            <!-- Stat cards will be injected here -->
        </div>

        <div class="section">
            <h2>⚠️ توزيع المشاكل حسب الخطورة</h2>
            <div class="severity-grid" id="severity-grid">
                <!-- Severity distribution will be injected here -->
            </div>
        </div>

        <div class="section">
            <h2>ملخص تقارير DeepSeek</h2>
            <div id="summary-container">Loading summary...</div>
        </div>

        <div class="section">
            <h2>🔍 تفاصيل المشاكل</h2>
            <div id="issues-details">
                <!-- Issues will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const timestampEl = document.getElementById('report-timestamp');
            timestampEl.textContent = `تاريخ التقرير: ${new Date().toLocaleString('ar-SA')}`;

            try {
                // Load available reports
                const centralRes = await fetch('/api/central-dashboard');
                if (centralRes.ok) {
                    const centralData = await centralRes.json();
                    displayCentralDashboard(centralData);
                } else {
                    document.getElementById('summary-container').textContent = 'النظام جاهز - لا توجد تقارير حالياً';
                    createDefaultStats();
                }

            } catch (error) {
                console.error('Error fetching report data:', error);
                document.getElementById('summary-container').textContent = 'فشل في تحميل التقارير';
                createDefaultStats();
            }
        });

        function displayCentralDashboard(data) {
            const statsGrid = document.getElementById('stats-grid');
            statsGrid.innerHTML = '';
            
            if (data && data.summary) {
                statsGrid.appendChild(createStatCard('إجمالي المهام', data.summary.totalTasks || 0));
                statsGrid.appendChild(createStatCard('مهام مكتملة', data.summary.completedTasks || 0));
                statsGrid.appendChild(createStatCard('مهام معلقة', data.summary.pendingTasks || 0));
                document.getElementById('summary-container').textContent = JSON.stringify(data, null, 2);
            } else {
                createDefaultStats();
            }
        }
        
        function createDefaultStats() {
            const statsGrid = document.getElementById('stats-grid');
            statsGrid.innerHTML = '';
            statsGrid.appendChild(createStatCard('حالة النظام', 'جاهز'));
            statsGrid.appendChild(createStatCard('الخدمات', 'نشطة'));
        }

        function parseSummary(summary) {
            const statsGrid = document.getElementById('stats-grid');
            statsGrid.innerHTML = ''; // Clear loader/placeholder

            const lines = summary.split('\n');
            const issueCounts = {};
            let totalIssues = 0;

            lines.forEach(line => {
                if (line.startsWith('- ')) {
                    const match = line.match(/- (\w+(?: \w+)*) issues: (\d+)/);
                    if (match) {
                        const type = match[1].replace(' ', '_').toLowerCase();
                        const count = parseInt(match[2], 10);
                        issueCounts[type] = count;
                        totalIssues += count;
                    }
                }
            });
            
            // Create total issues card
            statsGrid.appendChild(createStatCard('إجمالي المشاكل', totalIssues));

            // Create cards for each issue type
            for (const [type, count] of Object.entries(issueCounts)) {
                statsGrid.appendChild(createStatCard(type.replace('_', ' '), count));
            }

            // Parse severity table
            const severityGrid = document.getElementById('severity-grid');
            severityGrid.innerHTML = '';
            const tableRegex = /\|\s*Type\s*\|\s*LOW\s*\|\s*MEDIUM\s*\|\s*HIGH\s*\|\s*CRITICAL\s*\|([\s\S]*)/;
            const tableMatch = summary.match(tableRegex);
            if(tableMatch) {
                const rows = tableMatch[1].split('\n').filter(row => row.includes('|') && !row.startsWith('|---'));
                 const severities = { CRITICAL: 0, HIGH: 0, MEDIUM: 0, LOW: 0 };
                 rows.forEach(row => {
                     const cells = row.split('|').map(c => c.trim());
                     if(cells.length > 5) {
                         severities.LOW += parseInt(cells[2], 10) || 0;
                         severities.MEDIUM += parseInt(cells[3], 10) || 0;
                         severities.HIGH += parseInt(cells[4], 10) || 0;
                         severities.CRITICAL += parseInt(cells[5], 10) || 0;
                     }
                 });

                 for(const [sev, count] of Object.entries(severities)) {
                     if(count > 0) {
                         severityGrid.appendChild(createSeverityCard(sev, count));
                     }
                 }
            }
        }

        function createStatCard(label, count) {
            const card = document.createElement('div');
            card.className = 'stat-card';
            card.innerHTML = `<div class="stat-number">${count}</div><div>${label}</div>`;
            return card;
        }

        function createSeverityCard(severity, count) {
            const card = document.createElement('div');
            card.className = `severity-card sev-${severity}`;
            card.innerHTML = `<div style="font-size: 1.8rem;">${count}</div><div>${severity}</div>`;
            return card;
        }

        function createIssuesTable(type, issues) {
            if (!issues || issues.length === 0) return;

            const container = document.getElementById('issues-details');
            
            const header = document.createElement('h3');
            header.textContent = `تفاصيل مشاكل ${type.replace('_', ' ')}`;
            header.style.marginTop = '30px';
            header.style.marginBottom = '15px';
            container.appendChild(header);

            const table = document.createElement('table');
            table.className = 'issues-table';
            table.innerHTML = `
                <thead>
                    <tr><th>الملف</th><th>السطر</th><th>الخطورة</th><th>الوصف والحل المقترح</th></tr>
                </thead>
                <tbody>
                    ${issues.map(issue => `
                        <tr>
                            <td class="file-path">${issue.file}</td>
                            <td>${issue.line}</td>
                            <td><span class="severity-card sev-${issue.severity}" style="padding: 5px 10px; font-size: 0.8rem;">${issue.severity}</span></td>
                            <td>
                                <div>${issue.message}</div>
                                ${issue.suggestion && issue.suggestion.diff ? `<div class="suggestion">💡 ${issue.suggestion.diff}</div>` : ''}
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
            container.appendChild(table);
        }
    </script>
</body>
</html>